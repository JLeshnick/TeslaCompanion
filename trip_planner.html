<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Range Estimator - Tesla Companion</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    
    <!-- Open Source Map Libraries (Leaflet.js) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- Leaflet Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
</head>
<body>

    <header class="header">
        <div class="header-top">
            <div class="title-area">
                <div class="title">Tesla Companion</div>
            </div>
            <div class="top-right-controls">
                <button class="btn icon-btn" id="theme-toggle" title="Toggle Theme">
                    <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg id="theme-icon-moon" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                <a href="https://github.com/JLeshnick/TeslaCompanion" target="_blank" class="btn icon-btn" id="github-link" title="View on GitHub">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" style="width: 24px; height: 24px;"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                </a>
            </div>
        </div>
        <div class="main-tabs">
            <a href="index.html" class="tab-button">Home</a>
            <a href="camera_viewer.html" class="tab-button">Camera Viewer</a>
            <a href="trip_planner.html" class="tab-button active">Trip Range Estimator</a>
            <a href="charging.html" class="tab-button">Charging Time Estimator</a>
            <a href="phantom_drain.html" class="tab-button">Phantom Drain Estimator</a>
            <a href="howto.html" class="tab-button">How To</a>
            <a href="about.html" class="tab-button">About</a>
        </div>
    </header>

    <div class="content-container" style="overflow-y: auto;">
        <div class="calculator-container">
            <h1>Trip Range Estimator</h1>
            <div class="grid">
                <div class="form-group">
                    <label for="start-address">Start Address</label>
                    <div class="address-input-group">
                       <input type="text" id="start-address" placeholder="Enter starting point" autocomplete="off">
                       <button class="btn" id="use-current-location">Current Location</button>
                    </div>
                    <div id="start-address-results" class="autocomplete-results"></div>
                </div>
                <div class="form-group">
                    <label for="end-address">Destination Address</label>
                     <div class="address-input-group">
                        <input type="text" id="end-address" placeholder="Enter destination" autocomplete="off">
                    </div>
                    <div id="end-address-results" class="autocomplete-results"></div>
                </div>
            </div>
            <div id="trip-planner-map"></div>
            <hr>
            <div class="grid">
                <div class="form-group">
                    <label for="tesla-model">Vehicle</label>
                    <select id="tesla-model"></select>
                </div>
                <div class="form-group">
                    <label for="trip-start-soc">Starting Battery (%)</label>
                    <input type="number" id="trip-start-soc" value="90" min="0" max="100">
                </div>
            </div>
            <div id="custom-vehicle-params" class="grid" style="display:none;">
                <div class="form-group">
                    <label for="custom-capacity">Custom Capacity (kWh)</label>
                    <input type="number" id="custom-capacity" value="75">
                </div>
                <div class="form-group">
                    <label for="custom-efficiency">Custom Efficiency (Wh/mi)</label>
                    <input type="number" id="custom-efficiency" value="250">
                </div>
            </div>
            <div class="options-container is-open">
                 <div class="options-content" style="max-height: 1000px; opacity: 1; margin-top: 0; padding-bottom: 1rem;">
                    <div class="grid-4">
                        <div class="form-group">
                            <label for="road-conditions">Road Conditions</label>
                            <select id="road-conditions">
                                <option value="1.0" selected>Dry</option>
                                <option value="1.15">Wet</option>
                                <option value="1.3">Snow</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="wheel-size">Wheels</label>
                            <select id="wheel-size"></select>
                        </div>
                        <div class="form-group">
                            <label for="tire-pressure">Tire Pressure</label>
                            <select id="tire-pressure">
                                <option value="1.0" selected>Optimal</option>
                                <option value="1.03">Slightly Low</option>
                                <option value="1.08">Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payload">Additional Payload (lbs)</label>
                            <input type="number" id="payload" value="0" min="0" step="50">
                        </div>
                         <div class="form-group">
                            <label for="driving-style">Driving Style</label>
                            <select id="driving-style">
                                <option value="0.95">Chill (FSD)</option>
                                <option value="1.0" selected>Average (FSD)</option>
                                <option value="1.1">Assertive (FSD)</option>
                                <option value="manual">Manual</option>
                            </select>
                        </div>
                    </div>
                    <div id="manual-driving-slider-container" class="form-group slider-group" style="display:none;">
                        <label for="manual-aggression" class="slider-label"><span>Manual Driving: Eco</span><span>Aggressive</span></label>
                        <input type="range" id="manual-aggression" min="0.9" max="1.25" value="1.0" step="0.01">
                    </div>
                    <div class="grid">
                        <div class="form-group slider-group">
                            <label for="outdoor-temp" class="slider-label"><span>Outdoor Temperature</span><span id="outdoor-temp-value">70째F</span></label>
                            <input type="range" id="outdoor-temp" min="0" max="110" value="70">
                        </div>
                        <div class="form-group slider-group">
                            <label for="interior-temp" class="slider-label"><span>Interior Temperature</span><span id="interior-temp-value">70째F</span></label>
                            <input type="range" id="interior-temp" min="60" max="80" value="70">
                        </div>
                    </div>
                </div>
            </div>
            <button class="primary-btn" id="calculate-trip-btn">Estimate Trip</button>
            <div id="trip-result" class="result-box">Enter trip details above to see your estimate.</div>
        </div>
    </div>

<script>
    const teslaModelData = {
        'm3-sr': { name: 'Model 3 Standard Range', epaRange: 272, capacity: 54, efficiency: 250, wheels: { '18" Aero': 1.0, '19" Sport': 1.04 } },
        'm3-lr': { name: 'Model 3 Long Range', epaRange: 333, capacity: 75, efficiency: 250, wheels: { '18" Aero': 1.0, '19" Sport': 1.04 } },
        'm3-p': { name: 'Model 3 Performance', epaRange: 315, capacity: 75, efficiency: 260, wheels: { '20" Uberturbine': 1.0 } },
        'my-lr': { name: 'Model Y Long Range', epaRange: 330, capacity: 75, efficiency: 280, wheels: { '19" Gemini': 1.0, '20" Induction': 1.05 } },
        'my-p': { name: 'Model Y Performance', epaRange: 303, capacity: 75, efficiency: 300, wheels: { '21" Uberturbine': 1.0 } },
        'ms-lr': { name: 'Model S Long Range', epaRange: 405, capacity: 100, efficiency: 280, wheels: { '19" Tempest': 1.0, '21" Arachnid': 1.06 } },
        'ms-plaid': { name: 'Model S Plaid', epaRange: 396, capacity: 100, efficiency: 290, wheels: { '19" Tempest': 1.0, '21" Arachnid': 1.06 } },
        'mx-lr': { name: 'Model X Long Range', epaRange: 348, capacity: 100, efficiency: 320, wheels: { '20" Cyberstream': 1.0, '22" Turbine': 1.08 } },
        'mx-plaid': { name: 'Model X Plaid', epaRange: 333, capacity: 100, efficiency: 330, wheels: { '20" Cyberstream': 1.0, '22" Turbine': 1.08 } },
        'ct-awd': { name: 'Cybertruck AWD', epaRange: 340, capacity: 123, efficiency: 450, wheels: { '35" All-Terrain': 1.0 } },
    };

    const dom = {
        body: document.body,
        themeToggle: document.querySelector('#theme-toggle'),
        themeIconSun: document.querySelector('#theme-icon-sun'),
        themeIconMoon: document.querySelector('#theme-icon-moon'),
        
        tripPlannerMap: document.getElementById('trip-planner-map'),
        startAddressInput: document.getElementById('start-address'),
        startAddressResults: document.getElementById('start-address-results'),
        endAddressInput: document.getElementById('end-address'),
        endAddressResults: document.getElementById('end-address-results'),
        useCurrentLocationBtn: document.getElementById('use-current-location'),
        calculateTripBtn: document.getElementById('calculate-trip-btn'),
        tripResultDiv: document.getElementById('trip-result'),
        outdoorTempSlider: document.getElementById('outdoor-temp'),
        outdoorTempValue: document.getElementById('outdoor-temp-value'),
        interiorTempSlider: document.getElementById('interior-temp'),
        interiorTempValue: document.getElementById('interior-temp-value'),
        teslaModelSelect: document.getElementById('tesla-model'),
        customVehicleParams: document.getElementById('custom-vehicle-params'),
        wheelSelect: document.getElementById('wheel-size'),
        drivingStyleSelect: document.getElementById('driving-style'),
        manualAggressionContainer: document.getElementById('manual-driving-slider-container'),
        manualAggressionSlider: document.getElementById('manual-aggression'),
        payloadInput: document.getElementById('payload'),
        roadConditionsSelect: document.getElementById('road-conditions'),
        tirePressureSelect: document.getElementById('tire-pressure'),
    };
    
    let map = null;
    let routingControl = null;

    const applyTheme = (theme) => {
        if (theme === 'light') {
            dom.body.classList.add('light-mode');
            if(dom.tripPlannerMap) dom.tripPlannerMap.classList.remove('dark-mode');
            dom.themeIconSun.style.display = 'none';
            dom.themeIconMoon.style.display = 'block';
        } else {
            dom.body.classList.remove('light-mode');
            if(dom.tripPlannerMap) dom.tripPlannerMap.classList.add('dark-mode');
            dom.themeIconSun.style.display = 'block';
            dom.themeIconMoon.style.display = 'none';
        }
    }

    // --- Trip Planner Logic (Leaflet) ---
    function populateVehicleSelect() {
        dom.teslaModelSelect.innerHTML = '';
        for (const [key, model] of Object.entries(teslaModelData)) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = `${model.name} (${model.epaRange} mi)`;
            dom.teslaModelSelect.appendChild(option);
        }
        const customOption = document.createElement('option');
        customOption.value = 'custom';
        customOption.textContent = 'Custom...';
        dom.teslaModelSelect.appendChild(customOption);
    }

    function updateWheelOptions() {
        const modelKey = dom.teslaModelSelect.value;
        dom.wheelSelect.innerHTML = '';
        if (modelKey !== 'custom' && teslaModelData[modelKey] && teslaModelData[modelKey].wheels) {
            for (const [name, efficiency] of Object.entries(teslaModelData[modelKey].wheels)) {
                const option = document.createElement('option');
                option.value = efficiency;
                option.textContent = name;
                dom.wheelSelect.appendChild(option);
            }
            dom.wheelSelect.parentElement.style.display = 'block';
        } else {
             dom.wheelSelect.parentElement.style.display = 'none';
        }
    }

    function initTripPlannerMap() {
        map = L.map(dom.tripPlannerMap).setView([34.7304, -86.5861], 8); // Huntsville, AL
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        populateVehicleSelect();
        updateWheelOptions();
        applyTheme(localStorage.getItem('theme') || 'dark');
        
        initAutocomplete(dom.startAddressInput, dom.startAddressResults);
        initAutocomplete(dom.endAddressInput, dom.endAddressResults);
    }

    function useCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async position => {
                const { latitude, longitude } = position.coords;
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                const data = await response.json();
                if (data && data.display_name) {
                    dom.startAddressInput.value = data.display_name;
                } else {
                    alert("Could not find address for your location.");
                }
            }, () => {
                alert("Error: The Geolocation service failed.");
            });
        } else {
            alert("Error: Your browser doesn't support geolocation.");
        }
    }
    
    const debounce = (func, delay) => {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    };

    async function fetchAutocompleteResults(query, resultsContainer) {
        if (query.length < 2) { 
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
            return;
        }
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
        const results = await response.json();
        
        resultsContainer.innerHTML = '';
        if (results.length > 0) {
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = result.display_name;
                item.onclick = () => {
                    resultsContainer.previousElementSibling.querySelector('input').value = result.display_name;
                    resultsContainer.innerHTML = '';
                    resultsContainer.style.display = 'none';
                };
                resultsContainer.appendChild(item);
            });
            resultsContainer.style.display = 'block';
        } else {
            resultsContainer.style.display = 'none';
        }
    }

    function initAutocomplete(inputElement, resultsContainer) {
        const debouncedFetch = debounce(fetchAutocompleteResults, 250); 
        inputElement.addEventListener('input', () => {
            debouncedFetch(inputElement.value, resultsContainer);
        });
    }

    async function geocodeAddress(address) {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
        const results = await response.json();
        if (results && results.length > 0) {
            return L.latLng(results[0].lat, results[0].lon);
        } else {
            throw new Error(`Could not find coordinates for "${address}"`);
        }
    }

    async function calculateAndDisplayRoute() {
        const startAddress = dom.startAddressInput.value;
        const endAddress = dom.endAddressInput.value;
        dom.tripResultDiv.innerHTML = 'Calculating route...';

        if (!startAddress || !endAddress) {
            dom.tripResultDiv.innerHTML = "Please enter both a start and destination address.";
            return;
        }

        if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
        }

        try {
            const [startWaypoint, endWaypoint] = await Promise.all([
                geocodeAddress(startAddress),
                geocodeAddress(endAddress)
            ]);

            routingControl = L.Routing.control({
                waypoints: [startWaypoint, endWaypoint],
                routeWhileDragging: false,
                createMarker: () => null, 
                show: false, 
                lineOptions: {
                    styles: [{ color: 'var(--primary-color)', opacity: 0.8, weight: 6 }]
                },
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving',
                    routingOptions: {
                        alternatives: true,
                        steps: true,
                        overview: 'full',
                        geometries: 'geojson'
                    }
                })
            }).on('routesfound', function(e) {
                var routes = e.routes;
                estimateTrip(routes[0]);
            }).on('routingerror', function(e) {
                dom.tripResultDiv.innerHTML = `Could not find a route. Error: ${e.error.message}`;
            }).addTo(map);

        } catch (error) {
            console.error("Geocoding/Routing Error:", error);
            dom.tripResultDiv.innerHTML = error.message;
        }
    }

    function estimateTrip(route) {
        const distanceMeters = route.summary.totalDistance;
        const distanceMiles = distanceMeters * 0.000621371;
        
        let elevationGainMeters = 0;
        if (route.coordinates && route.coordinates.length > 0) {
            for (let i = 1; i < route.coordinates.length; i++) {
                if(route.coordinates[i].alt > route.coordinates[i-1].alt) {
                   elevationGainMeters += route.coordinates[i].alt - route.coordinates[i-1].alt;
                }
            }
        }
        const elevationGainFeet = elevationGainMeters * 3.28084;

        const modelKey = dom.teslaModelSelect.value;
        let model;

        if (modelKey === 'custom') {
            model = {
                capacity: parseFloat(document.getElementById('custom-capacity').value),
                efficiency: parseFloat(document.getElementById('custom-efficiency').value),
            };
        } else {
            model = teslaModelData[modelKey];
        }
        
        const startSOC = parseFloat(document.getElementById('trip-start-soc').value);
        const outdoorTempF = parseFloat(dom.outdoorTempSlider.value);
        const interiorTempF = parseFloat(dom.interiorTempSlider.value);
        const payloadLbs = parseFloat(dom.payloadInput.value);
        
        let drivingStyleMultiplier = parseFloat(dom.drivingStyleSelect.value);
        if (dom.drivingStyleSelect.value === 'manual') {
            drivingStyleMultiplier = parseFloat(dom.manualAggressionSlider.value);
        }
        const wheelMultiplier = parseFloat(dom.wheelSelect.value) || 1.0;
        const roadConditionMultiplier = parseFloat(dom.roadConditionsSelect.value);
        const tirePressureMultiplier = parseFloat(dom.tirePressureSelect.value);
        
        if (isNaN(startSOC) || isNaN(model.capacity) || isNaN(model.efficiency)) {
            dom.tripResultDiv.innerHTML = "Please enter valid vehicle and battery info.";
            return;
        }

        let adjustedEfficiency = model.efficiency * wheelMultiplier * drivingStyleMultiplier * roadConditionMultiplier * tirePressureMultiplier;
        let totalWhConsumed = distanceMiles * adjustedEfficiency;

        let tempMultiplier = 1.0;
        if (outdoorTempF < 40) { 
            tempMultiplier = 1 + (40 - outdoorTempF) * 0.015; 
        } else if (outdoorTempF > 90) { 
            tempMultiplier = 1 + (outdoorTempF - 90) * 0.005; 
        }
        totalWhConsumed *= tempMultiplier;

        const tempDifference = Math.abs(outdoorTempF - interiorTempF);
        if (tempDifference > 5) {
            const hvacWatts = 250 + Math.pow(tempDifference, 2) * 2; 
            const tripDurationHours = (distanceMiles / 55); 
            const hvacWhConsumed = hvacWatts * tripDurationHours;
            totalWhConsumed += hvacWhConsumed;
        }
        
        const payloadWhConsumed = (payloadLbs / 200) * 0.01 * totalWhConsumed; 
        totalWhConsumed += payloadWhConsumed;

        const totalMassKg = (4500 + payloadLbs) * 0.453592;
        const elevationWhConsumed = (totalMassKg * 9.81 * elevationGainMeters) / 3600;
        const elevationWhRegained = elevationWhConsumed * 0.60;
        totalWhConsumed += (elevationWhConsumed - elevationWhRegained);

        const percentUsed = (totalWhConsumed / (model.capacity * 1000)) * 100;
        const endSOC = startSOC - percentUsed;

        dom.tripResultDiv.innerHTML = `
            Trip: <strong>${distanceMiles.toFixed(1)} miles</strong> | Elev. Gain: <strong>${Math.round(elevationGainFeet)} ft</strong><br>
            Estimated Arrival SOC: <strong style="color: ${endSOC < 20 ? 'var(--error-color)' : 'var(--success-color)'}; font-size: 1.5rem;">${Math.round(endSOC)}%</strong><br>
            <small>(Used ~${percentUsed.toFixed(1)}% of the battery)</small>
        `;
    }

    // --- Initialization ---
    dom.themeToggle.addEventListener('click', () => {
        const newTheme = dom.body.classList.contains('light-mode') ? 'dark' : 'light';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    });
    
    // Trip Planner Listeners
    dom.useCurrentLocationBtn.addEventListener('click', useCurrentLocation);
    dom.calculateTripBtn.addEventListener('click', calculateAndDisplayRoute);
    dom.outdoorTempSlider.addEventListener('input', (e) => dom.outdoorTempValue.textContent = `${e.target.value}째F`);
    dom.interiorTempSlider.addEventListener('input', (e) => dom.interiorTempValue.textContent = `${e.target.value}째F`);
    dom.teslaModelSelect.addEventListener('change', () => {
        dom.customVehicleParams.style.display = dom.teslaModelSelect.value === 'custom' ? 'grid' : 'none';
        updateWheelOptions();
    });
    dom.drivingStyleSelect.addEventListener('change', () => {
         dom.manualAggressionContainer.style.display = dom.drivingStyleSelect.value === 'manual' ? 'block' : 'none';
    });
    
    // Hide autocomplete on global click
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.address-input-group')) {
            dom.startAddressResults.style.display = 'none';
            dom.endAddressResults.style.display = 'none';
        }
    });

    // Start
    applyTheme(localStorage.getItem('theme') || 'dark');
    initTripPlannerMap();
    
    // Skip splash screen on return to index
    sessionStorage.setItem('appLaunched', 'true');

</script>
</body>
</html>
