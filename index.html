<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla Companion</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Open Source Map Libraries (Leaflet.js) - No API Key Needed -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Leaflet Routing Machine for directions -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- Leaflet Geocoder for address lookup and autocomplete (Fixes the error) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        :root {
            /* Dark Theme (Default) */
            --bg-color: #0a0a0a;
            --surface-color: #1a1a1a;
            --surface-elevated: #252525;
            --primary-color: #E82127;
            --primary-hover-color: #c01a11;
            --secondary-color: #0066ff;
            --accent-color: #00d4aa;
            --text-color: #f0f0f0;
            --text-muted-color: #9ca3af;
            --text-dim-color: #6b7280;
            --border-color: #374151;
            --border-hover-color: #4b5563;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
            --control-bg-color: rgba(255, 255, 255, 0.05);
            --control-bg-hover: rgba(255, 255, 255, 0.1);
            --control-bg-active: rgba(255, 255, 255, 0.15);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        body.light-mode {
            /* Light Theme */
            --bg-color: #f8fafc;
            --surface-color: #ffffff;
            --surface-elevated: #f1f5f9;
            --primary-color: #E82127;
            --primary-hover-color: #d01e24;
            --secondary-color: #0066ff;
            --accent-color: #00d4aa;
            --text-color: #1e293b;
            --text-muted-color: #64748b;
            --text-dim-color: #94a3b8;
            --border-color: #e2e8f0;
            --border-hover-color: #cbd5e1;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --control-bg-color: rgba(0, 0, 0, 0.03);
            --control-bg-hover: rgba(0, 0, 0, 0.08);
            --control-bg-active: rgba(0, 0, 0, 0.12);
        }

        /* --- Global Styles & Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--surface-color); border-radius: var(--border-radius-md); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: var(--border-radius-md); transition: var(--transition-fast); }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-hover-color); }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            transition: background-color var(--transition-normal);
            font-size: 14px;
            line-height: 1.5;
        }

        /* --- Landing Page Styles --- */
        #landing-page {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            height: 100vh;
            width: 100%;
            padding: 2rem;
            box-sizing: border-box;
            background: linear-gradient(135deg, var(--bg-color) 0%, var(--surface-color) 100%);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            z-index: 100;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        #landing-page.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }

        .landing-content {
            max-width: 600px;
            animation: fadeInFromBottom 1s ease-out;
        }
        
        @keyframes fadeInFromBottom {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .landing-logo {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .landing-subtitle {
            font-size: 1.25rem;
            color: var(--text-muted-color);
            margin-bottom: 2.5rem;
        }

        .feature-list {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-bottom: 3rem;
        }

        .feature-item {
            background: var(--control-bg-color);
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius-lg);
            font-weight: 500;
            color: var(--text-muted-color);
            border: 1px solid var(--border-color);
            transition: all var(--transition-fast);
        }
        
        .feature-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            color: var(--text-color);
            border-color: var(--border-hover-color);
        }
        
        #launch-app-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover-color));
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 1rem 3rem;
            border-radius: var(--border-radius-lg);
            border: none;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-lg);
        }
        
        #launch-app-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--shadow-xl);
        }
        
        #launch-app-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        /* --- Main App Styles --- */
        .layout-container { 
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: opacity 0.5s ease-in;
            opacity: 1;
        }

        .layout-container.hidden {
            display: none;
            opacity: 0;
        }
        
        .header {
            background: var(--surface-color);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            box-shadow: var(--shadow-lg);
            z-index: 20;
            padding: 0.75rem 1.5rem;
            transition: var(--transition-normal);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .title-area { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
        .title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            white-space: nowrap;
        }

        .main-tabs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--surface-elevated);
            padding: 0.5rem;
            border-radius: var(--border-radius-lg);
            justify-self: center;
            overflow-x: auto;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            border: none;
            background-color: transparent;
            color: var(--text-muted-color);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: var(--border-radius-md);
            transition: background-color 0.3s ease, color 0.3s ease;
            white-space: nowrap;
        }
        .tab-button.active {
            background-color: var(--control-bg-hover);
            color: var(--text-color);
            box-shadow: var(--shadow-sm);
        }

        .top-right-controls { display: flex; align-items: center; gap: 0.75rem; }
        
        .file-select-stack, .event-action-stack, .utility-btn-stack {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: stretch;
        }
        
        .utility-btn-stack .btn {
            padding: 0.25rem;
            width: 38px;
            height: 38px;
        }

        .clip-info { display: flex; flex-direction: column; justify-content: center; line-height: 1.4; gap: 0.25rem; }
        .title-folder-name { color: var(--text-color); font-weight: 600; font-size: 0.9rem; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; max-width: 250px; }
        
        .event-detail-item {
            font-size: 0.8rem;
            color: var(--text-muted-color);
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .event-detail-item strong {
            font-weight: 600;
            color: var(--text-color);
        }


        #camera-controls-container {
            padding: 1rem 1.5rem;
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
        }
        .header-row { display: flex; width: 100%; align-items: center; flex-wrap: wrap; }
        .top-ribbon {
            display: grid;
            gap: 1rem;
            width: 100%;
            grid-template-columns: auto 1fr auto;
            align-items: center;
        }
        
        .main-playback-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            background: var(--surface-elevated);
            border-radius: var(--border-radius-xl);
            padding: 0.5rem;
            box-shadow: var(--shadow-md);
        }
        
        .file-select-stack {
            flex-shrink: 0;
        }

        .time-display {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            color: var(--text-muted-color);
            margin: 0 0.5rem;
            background: var(--control-bg-color);
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
        }
        
        .progress-container { padding: 0.75rem 0; position: relative; }
        #master-scrubber { width: 100%; cursor: pointer; -webkit-appearance: none; appearance: none; height: 6px; background: var(--border-color); border-radius: var(--border-radius-md); outline: none; transition: var(--transition-fast); }
        #master-scrubber:hover { height: 8px; }
        #master-scrubber::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: linear-gradient(135deg, var(--primary-color), var(--primary-hover-color)); border-radius: 50%; cursor: pointer; border: 3px solid var(--surface-color); box-shadow: var(--shadow-md); transition: var(--transition-fast); }
        #master-scrubber:hover::-webkit-slider-thumb { transform: scale(1.2); box-shadow: var(--shadow-lg); }
        #event-marker { position: absolute; top: 50%; width: 4px; height: 20px; background: linear-gradient(135deg, var(--accent-color), var(--secondary-color)); border-radius: var(--border-radius-sm); transform: translate(-50%, -50%); z-index: 2; display: none; pointer-events: none; box-shadow: var(--shadow-md); }
        
        .collapsible-panel { max-height: 0; overflow: hidden; transition: max-height var(--transition-slow), padding var(--transition-slow); padding: 0; display: flex; flex-direction: column; gap: 1.5rem; border-top: 1px solid transparent; }
        .collapsible-panel.visible { max-height: 600px; padding: 1.5rem 0 1rem; border-top: 1px solid var(--border-color); }
        .panel-section { display: flex; flex-wrap: wrap; align-items: center; gap: 2rem; background: var(--surface-elevated); padding: 1rem 1.5rem; border-radius: var(--border-radius-lg); border: 1px solid var(--border-color); }
        .panel-section .control-group { gap: 1rem; }

        .btn { display: inline-flex; align-items: center; justify-content: center; background: var(--control-bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: var(--transition-fast); gap: 0.5rem; text-decoration: none; user-select: none; position: relative; overflow: hidden; }
        .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent); transition: left var(--transition-normal); }
        .btn:hover::before { left: 100%; }
        .btn:hover { background: var(--control-bg-hover); border-color: var(--border-hover-color); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn:active { transform: translateY(0); box-shadow: var(--shadow-sm); }
        .btn svg { width: 18px; height: 18px; transition: var(--transition-fast); flex-shrink: 0; }
        #theme-toggle svg, #github-link svg, #fullscreen-toggle svg { width: 24px; height: 24px; }
        .main-playback-controls .icon-btn { width: 42px; height: 42px; padding: 0; flex-shrink: 0; border-radius: 50%; }
        #play-pause-button { background: linear-gradient(135deg, var(--primary-color), var(--primary-hover-color)); color: white; border-color: var(--primary-color); width: 48px; height: 48px; }
        #play-pause-button:hover { background: linear-gradient(135deg, var(--primary-hover-color), var(--primary-color)); transform: scale(1.05); box-shadow: var(--shadow-lg); }
        
        .file-select-stack .btn,
        .file-select-stack .styled-input,
        .event-action-stack .btn {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }

        .content-container { flex-grow: 1; overflow: hidden; background: var(--bg-color); display: flex; flex-direction: column;}
        .tab-content { display: none; flex-grow: 1; flex-direction: column; overflow-y: auto; }
        .tab-content.active { display: flex; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #CameraViewer .video-grid-container { flex-grow: 1; overflow: auto; padding: 1rem; }
        .video-grid { display: grid; height: 100%; width: 100%; gap: 0.5rem; grid-template-areas: "left-pillar front right-pillar" "left-repeater back right-repeater"; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .video-container.hidden { display: none; }
        .video-grid.single-view-mode .video-container:not(.hidden) { grid-area: initial; grid-column: 1 / -1; grid-row: 1 / -1; }
        
        .video-grid.expanded-view .video-container { display: none; }
        .video-grid.expanded-view .video-container.expanded { display: flex; grid-area: 1 / 1 / -1 / -1; }

        .video-container { position: relative; background: linear-gradient(135deg, #1a1a1a, #2a2a2a); border: 2px solid var(--border-color); border-radius: var(--border-radius-lg); overflow: hidden; display: flex; align-items: center; justify-content: center; transition: var(--transition-fast); box-shadow: var(--shadow-md); cursor: pointer; }
        .video-container:hover { border-color: var(--primary-color); box-shadow: var(--shadow-lg); transform: translateY(-2px); }
        .video-container.triggered { border-color: var(--accent-color); }
        .video-container.triggered .video-label { background: linear-gradient(135deg, var(--accent-color), var(--primary-color)); color: white; border-color: rgba(255,255,255,0.3); }
        
        .video-label { position: absolute; top: 12px; left: 12px; background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(0,0,0,0.9)); color: white; padding: 0.4rem 0.8rem; font-size: 0.75rem; font-weight: 600; border-radius: var(--border-radius-md); pointer-events: none; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); z-index: 1; }
        video { width: 100%; height: 100%; object-fit: contain; border-radius: calc(var(--border-radius-lg) - 2px); }
        .video-container.front { grid-area: front; } .video-container.back { grid-area: back; } .video-container.left_repeater { grid-area: left-repeater; } .video-container.right_repeater { grid-area: right-repeater; } .video-container.left_pillar { grid-area: left-pillar; } .video-container.right_pillar { grid-area: right-pillar; }
        
        .info-container, .calculator-container { max-width: 800px; margin: 2rem auto; padding: 2rem 2rem 4rem 2rem; background-color: var(--surface-color); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-lg); width: 100%; }
        .info-container h1, .calculator-container h1 { text-align: center; font-size: 1.5rem; margin-top: 0; margin-bottom: 2rem; color: var(--text-color); }
        .info-container h2 { font-size: 1.25rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-top: 2rem; margin-bottom: 1rem; }
        .info-container p, .info-container li { color: var(--text-muted-color); }
        .info-container ul { list-style-type: none; padding-left: 0; }
        .info-container li { margin-bottom: 0.75rem; padding-left: 1.5rem; position: relative; }
        .info-container li::before { content: 'âœ“'; position: absolute; left: 0; color: var(--accent-color); font-weight: bold; }
        .info-container table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .info-container th, .info-container td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .info-container th { font-weight: 600; color: var(--text-color); }
        .info-container code { background-color: var(--control-bg-color); padding: 0.2rem 0.4rem; border-radius: var(--border-radius-sm); font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;}

        .form-group { margin-bottom: 1.25rem; }
        .calculator-container label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; color: var(--text-muted-color); }
        .calculator-container input, .calculator-container select { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); box-sizing: border-box; font-size: 1rem; background-color: var(--control-bg-color); color: var(--text-color); transition: var(--transition-fast); }
        .calculator-container select option { background: var(--surface-elevated); color: var(--text-color); }
        .calculator-container input:hover, .calculator-container select:hover { border-color: var(--border-hover-color); }
        .calculator-container input:focus, .calculator-container select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(232, 33, 39, 0.1); }
        .primary-btn { width: 100%; padding: 0.85rem; border: none; border-radius: var(--border-radius-md); background: linear-gradient(135deg, var(--primary-color), var(--primary-hover-color)); color: white; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 1.5rem; transition: var(--transition-normal); box-shadow: var(--shadow-md); }
        .primary-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        hr { border: 0; border-top: 1px solid var(--border-color); margin: 2rem 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; }
        .result-box { margin-top: 2rem; padding: 1.5rem; text-align: center; font-size: 1.2rem; font-weight: 600; line-height: 1.5; background-color: var(--surface-elevated); border-radius: var(--border-radius-lg); border: 1px solid var(--border-color); min-height: 50px; color: var(--text-color); }
        .checkbox-group { display: flex; align-items: center; margin-bottom: 0.75rem; padding: 0.5rem; border-radius: var(--border-radius-md); transition: background-color 0.2s; }
        .checkbox-group:hover { background-color: var(--control-bg-color); }
        .checkbox-group input { width: auto; margin-right: 0.75rem; accent-color: var(--primary-color); }
        .checkbox-group label { margin-bottom: 0; font-weight: normal; color: var(--text-color); }

        /* --- Phantom Drain Calculator Styles --- */
        .calc-mode-switcher {
            display: flex;
            background-color: var(--surface-elevated);
            border-radius: var(--border-radius-md);
            padding: 0.25rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .mode-btn {
            flex: 1;
            padding: 0.75rem 0.5rem;
            border: none;
            background-color: transparent;
            color: var(--text-muted-color);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: var(--border-radius-sm);
            transition: background-color 0.3s ease, color 0.3s ease;
            text-align: center;
        }
        .mode-btn.active {
            background-color: var(--control-bg-hover);
            color: var(--text-color);
            box-shadow: var(--shadow-sm);
        }
        .calc-mode-content { display: none; }
        .calc-mode-content.active { display: block; animation: fadeIn 0.5s; }

        .options-container {
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
        }
        .options-toggle-btn {
            background: none;
            border: none;
            color: var(--text-muted-color);
            font-weight: 600;
            cursor: pointer;
            padding: 1rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            font-size: 0.9rem;
            transition: color var(--transition-fast);
        }
        .options-toggle-btn:hover {
            color: var(--primary-color);
        }
        .options-toggle-btn .chevron-icon {
            width: 20px;
            height: 20px;
            transition: transform var(--transition-normal);
            stroke: currentColor;
        }
        .options-container.is-open .chevron-icon {
            transform: rotate(180deg);
        }
        .options-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.5s ease, opacity 0.5s ease, margin-top 0.5s ease;
            margin-top: 0;
        }
        .options-container.is-open .options-content {
            max-height: 1000px; /* Increased max-height */
            opacity: 1;
            margin-top: 0;
            padding-bottom: 1rem;
        }


        .camera-toggles { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .camera-toggles .divider { border-left: 2px solid var(--border-color); height: 24px; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--border-color); transition: var(--transition-normal); border-radius: 24px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: linear-gradient(135deg, #ffffff, #f0f0f0); transition: var(--transition-normal); border-radius: 50%; box-shadow: var(--shadow-sm); }
        input:checked + .slider { background: linear-gradient(135deg, var(--primary-color), var(--primary-hover-color)); }
        input:checked + .slider:before { transform: translateX(20px); }
        .toggle-label { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; user-select: none; font-size: 0.875rem; font-weight: 500; transition: var(--transition-fast); }
        .toggle-label:hover { color: var(--primary-color); }
        
        select.styled-input option {
            background: var(--surface-elevated);
            color: var(--text-color);
        }

        .styled-input { background: var(--control-bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 0.5rem 1rem; font-size: 0.875rem; cursor: pointer; transition: var(--transition-fast); -webkit-appearance: none; appearance: none; backdrop-filter: blur(10px); }
        .styled-input:hover { border-color: var(--border-hover-color); box-shadow: var(--shadow-sm); }
        .styled-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(232, 33, 39, 0.1); }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 0.5rem; transition: background-color 0.3s; }
        .status-dot.ready { background: var(--success-color); animation: none; }
        .status-dot.playing { background-color: var(--error-color); animation: playing-pulse 2s infinite; }
        
        @keyframes playing-pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .btn:focus-visible, .switch:focus-within { outline: 2px solid var(--primary-color); outline-offset: 2px; }
        .switch:focus-within { border-radius: 24px; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .header { animation: slideIn 0.5s ease-out; }

        /* --- Map Overlay Styles --- */
        #map-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            z-index: 110; /* Higher than header */
            animation: fadeIn 0.3s ease;
        }

        #map-iframe {
            width: 90vw;
            height: 90vh;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
        }

        #map-close-button {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 3rem;
            color: #fff;
            cursor: pointer;
            line-height: 1;
            transition: transform 0.2s ease;
        }

        #map-close-button:hover {
            transform: scale(1.2) rotate(90deg);
        }
        
        /* --- Fullscreen Styles --- */
        body.fullscreen-active .header,
        body.fullscreen-active #camera-controls-container {
            display: none;
        }
        body.fullscreen-active .content-container {
            padding: 0;
            height: 100vh;
        }
        body.fullscreen-active #CameraViewer {
            height: 100%;
        }
        body.fullscreen-active #CameraViewer .video-grid-container {
            padding: 0;
            max-height: 100vh;
        }
        body.fullscreen-active .video-grid {
            gap: 1px;
        }
        body.fullscreen-active .video-container {
            border-radius: 0;
            border: 1px solid var(--bg-color);
        }
        body.fullscreen-active .video-container.triggered {
            border-color: var(--accent-color);
        }

        /* --- Trip Planner Styles (Leaflet) --- */
        #trip-planner-map {
            height: 400px;
            width: 100%;
            background-color: var(--control-bg-color);
            border-radius: var(--border-radius-lg);
            margin-top: 1.5rem;
            border: 1px solid var(--border-color);
            z-index: 10;
        }
        #trip-planner-map.dark-mode .leaflet-tile-pane {
             filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }
        .address-input-group {
            position: relative;
            display: flex;
            align-items: center;
        }
        .address-input-group input {
            flex-grow: 1;
        }
        .address-input-group .btn {
            margin-left: 0.5rem;
            flex-shrink: 0;
        }
        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .slider-group .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-muted-color);
        }
        .slider-group input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: var(--border-radius-md);
            outline: none;
            transition: var(--transition-fast);
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid var(--surface-color);
            box-shadow: var(--shadow-md);
        }
        /* Style the routing panel */
        .leaflet-routing-container {
            background-color: var(--surface-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
        }
        .leaflet-routing-alt, .leaflet-routing-geocoders, .leaflet-routing-error {
            background-color: var(--surface-elevated);
            border-top: 1px solid var(--border-color);
            color: var(--text-muted-color);
        }
        .leaflet-routing-alt:hover {
            background-color: var(--control-bg-hover);
        }
        .leaflet-routing-instruction {
            color: var(--text-color);
        }
        .leaflet-routing-icon {
            background-color: var(--surface-elevated);
            border-radius: 50%;
        }
        
        /* Autocomplete Styles */
        .autocomplete-results {
            position: absolute;
            background-color: var(--surface-elevated);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 150px); /* Adjust width based on button */
            box-sizing: border-box;
            z-index: 1000;
            margin-top: 4px;
            top: 100%;
        }
        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .autocomplete-item:hover {
            background-color: var(--control-bg-hover);
        }


        /* Responsive Design */
        @media (max-width: 1250px) {
            .top-ribbon {
                display: grid;
                grid-template-areas:
                    "playback playback"
                    "details files";
                grid-template-columns: 1fr auto;
                gap: 1rem;
            }
            .main-playback-controls { grid-area: playback; }
            .title-area { grid-area: details; justify-self: start; align-self: center; }
            .file-select-stack { grid-area: files; justify-self: end; align-self: center; }
        }

        @media (max-width: 768px) {
            .header { padding: 0.75rem 1rem; }
            .header-top { flex-direction: column; gap: 0.75rem; }
            .title { font-size: 1.25rem; }

            .top-ribbon {
                grid-template-areas:
                    "playback"
                    "details"
                    "files";
                grid-template-columns: 1fr;
                justify-items: center;
            }
            .title-area, .file-select-stack { justify-self: center; }

            .main-playback-controls { gap: 0.5rem; padding: 0.5rem; flex-wrap: wrap; }
            .main-playback-controls .icon-btn { width: 38px; height: 38px; }
            #play-pause-button { width: 44px; height: 44px; }
            #CameraViewer .video-grid-container { padding: 0.5rem; }
            .video-grid { gap: 0.5rem; }
            .panel-section { padding: 1rem; gap: 1rem; }
            .grid, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="landing-page">
    <div class="landing-content">
        <div class="landing-logo">Tesla Companion</div>
        <p class="landing-subtitle">Your Toolkit for Viewing Camera Clips, Estimating Trips, Charging, Phantom Drain, and more.</p>
        <div class="feature-list">
            <div class="feature-item">Camera Viewer</div>
            <div class="feature-item">Trip Range Estimator</div>
            <div class="feature-item">Charging Estimator</div>
            <div class="feature-item">Phantom Drain Estimator</div>
        </div>
        <button id="launch-app-btn">Launch Application</button>
    </div>
</div>

<div class="layout-container hidden"> 
    <header class="header">
        <div class="header-top">
            <div class="title-area">
                <div class="title">Tesla Companion</div>
            </div>
            <div class="top-right-controls">
                <button class="btn icon-btn" id="theme-toggle" title="Toggle Theme">
                    <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg id="theme-icon-moon" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                <a href="https://github.com/JLeshnick/TeslaCompanion" target="_blank" class="btn icon-btn" id="github-link" title="View on GitHub">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" style="width: 24px; height: 24px;"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                </a>
            </div>
        </div>
        <div class="main-tabs">
            <button class="tab-button active" onclick="openTab(event, 'HowTo')">How To</button>
            <button class="tab-button" onclick="openTab(event, 'CameraViewer')">Camera Viewer</button>
            <button class="tab-button" onclick="openTab(event, 'TripRangeEstimator')">Trip Range Estimator</button>
            <button class="tab-button" onclick="openTab(event, 'ChargingEstimator')">Charging Time Estimator</button>
            <button class="tab-button" onclick="openTab(event, 'PhantomDrain')">Phantom Drain Estimator</button>
            <button class="tab-button" onclick="openTab(event, 'About')">About</button>
        </div>
    </header>

    <div class="content-container">
        <div id="HowTo" class="tab-content active">
            <div class="info-container">
                <h1>How To Use Tesla Companion</h1>
                <p>Welcome to your all-in-one Tesla toolkit. Here's a guide to get you started:</p>
                
                <h2>Camera Viewer</h2>
                <ul>
                    <li><strong>Load Clips:</strong> Click the "Select Directory" button and choose your main `TeslaCam` folder from your USB drive. The app will automatically find and group all video events.</li>
                    <li><strong>Navigate Events:</strong> Use the dropdown or navigation buttons to move between events.</li>
                    <li><strong>Playback:</strong> Use the main playback controls to play, pause, skip, and scrub through the combined video clips for an event.</li>
                    <li><strong>Jump to Event:</strong> If an event was triggered, a "Jump to Event" button will appear.</li>
                    <li><strong>View Location:</strong> If the event contains GPS data, a "Event Map" button will appear.</li>
                    <li><strong>Grid Screenshots:</strong> Use the "Screenshot" button in the top controls to download a single, high-quality image stitching all visible camera feeds together.</li>
                </ul>

                <h2>Trip Range Estimator</h2>
                <ul>
                    <li><strong>Enter Locations:</strong> Type in a starting and destination address. You can also click "Use Current Location" for the starting point.</li>
                    <li><strong>Select Vehicle:</strong> Choose your Tesla model from the dropdown. This sets the battery capacity and efficiency.</li>
                    <li><strong>Set Trip Parameters:</strong> Enter your starting battery percentage, payload, and wheel size. Select your driving style and road conditions. Use the sliders to set the expected outdoor temperature and your desired interior cabin temperature.</li>
                    <li><strong>Calculate:</strong> Click "Estimate Trip" to see the route on the map and get an estimate of your remaining battery percentage upon arrival. The calculation considers all selected factors for a more accurate result.</li>
                </ul>

                <h2>Charging Time Estimator</h2>
                <ul>
                    <li><strong>Enter Details:</strong> Input your vehicle's original battery capacity, your current and target battery percentage, and the efficiency of your charger.</li>
                    <li><strong>Select Charger:</strong> Choose from common charger types (Mobile, Level 2, Supercharger) or select "Custom" to input specific voltage and amperage.</li>
                    <li><strong>Calculate:</strong> Click the button to get an estimate of how long your charging session will take.</li>
                </ul>
                
                <h2>Phantom Drain Estimator</h2>
                <ul>
                    <li><strong>Calculate Drain Time:</strong> Enter your current battery percentage and the percentage you expect it to drain to. The tool will estimate how long your battery will last under the selected conditions.</li>
                    <li><strong>Calculate Percentage Lost:</strong> Enter your current battery percentage, a start time/date, and an end time/date. The tool will estimate how much battery percentage will be lost in that period.</li>
                    <li><strong>Refine Calculation:</strong> For both modes, add your battery's current health, the outside temperature, and select any active features (like Sentry Mode) for a more accurate calculation.</li>
                </ul>

                <h2>Reference Information</h2>
                <h3>Camera Indexes</h3>
                <p>The <code>event.json</code> file references cameras by a number. Here is the mapping used by this application:</p>
                <table>
                    <thead><tr><th>Index</th><th>Camera View</th></tr></thead>
                    <tbody>
                        <tr><td><code>0</code></td><td>Front</td></tr>
                        <tr><td><code>3</code></td><td>Left Pillar</td></tr>
                        <tr><td><code>4</code></td><td>Right Pillar</td></tr>
                        <tr><td><code>5</code></td><td>Left Repeater</td></tr>
                        <tr><td><code>6</code></td><td>Right Repeater</td></tr>
                        <tr><td><code>7</code></td><td>Back</td></tr>
                    </tbody>
                </table>
                <h3>Event Reasons</h3>
                <p>The <code>reason</code> field in the event file indicates what triggered the recording. Here are some common reasons:</p>
                <table>
                    <thead><tr><th>Reason Code</th><th>Description</th></tr></thead>
                    <tbody>
                        <tr><td><code>sentry_aware_object_detection</code></td><td>Sentry Mode detected an object or movement nearby.</td></tr>
                        <tr><td><code>user_interaction_dashcam_icon_tapped</code></td><td>You manually triggered a Dashcam recording by tapping the icon on the screen.</td></tr>
                        <tr><td><code>sentry_locked_handle_pulled</code></td><td>Sentry Mode detected someone pulling on a door handle while the car was locked.</td></tr>
                        <tr><td><code>user_interaction_honk</code></td><td>You manually triggered a Dashcam recording by honking the horn.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="CameraViewer" class="tab-content">
             <div id="camera-controls-container">
                    <div class="header-main">
                            <div class="header-row top-ribbon">
                                <div class="title-area">
                                    <div class="clip-info">
                                        <span class="title-folder-name">No Clips Selected</span>
                                        <div id="event-details-container" style="display: none;">
                                            <div id="event-reason-display" class="event-detail-item"></div>
                                            <div id="event-time-display" class="event-detail-item"></div>
                                            <div id="event-trigger-display" class="event-detail-item"></div>
                                            <div id="event-city-display" class="event-detail-item"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="main-playback-controls">
                                    <div class="event-action-stack">
                                        <button class="btn" id="jump-to-event" style="display: none;" title="Jump to event trigger">Jump to Event</button>
                                        <button class="btn" id="map-button" style="display: none;" title="View on Map">Event Map</button>
                                    </div>
                                    <button class="btn icon-btn previous" title="Previous Clip"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" height="24" viewBox="0 0 24 24" width="24"><path d="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6zM6 6h2v12H6z"></path></svg></button>
                                    <button class="btn" id="skip-rewind" title="Rewind 5s">-5s</button>
                                    <button class="btn icon-btn" id="play-pause-button"><svg id="play-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" height="24" viewBox="0 0 24 24" width="24"><path d="M8 5v14l11-7z"></path></svg><svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg></button>
                                    <button class="btn" id="skip-forward" title="Forward 5s">+5s</button>
                                    <button class="btn icon-btn next" title="Next Clip"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" height="24" viewBox="0 0 24 24" width="24"><path d="M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6-6-6zM16 6h2v12h-2z"></path></svg></button>
                                    <select id="playback-speed" class="styled-input" title="Playback Speed"><option value="0.25">0.25x</option><option value="0.5">0.5x</option><option value="1" selected>1x</option><option value="1.5">1.5x</option><option value="2">2x</option><option value="4">4x</option></select>
                                    <div class="time-display"><span class="status-dot ready"></span><span id="live-timestamp">00:00</span> / <span id="duration-display">00:00</span></div>
                                    <div class="utility-btn-stack">
                                        <button class="btn icon-btn" id="screenshot-btn" title="Screenshot"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></button>
                                        <button class="btn icon-btn" id="fullscreen-toggle" title="Toggle Fullscreen">
                                            <svg id="maximize-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                                            <svg id="minimize-icon" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="file-select-stack">
                                    <label for="fileBrowser" class="btn"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px; margin-right: 0.5rem;"><path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/></svg>Select Directory</label>
                                    <input type="file" id="fileBrowser" webkitdirectory multiple hidden>
                                    <select id="date-select" class="styled-input"><option>Select Event</option></select>
                                </div>
                            </div>
                            <div class="header-row progress-container">
                                <div id="event-marker"></div>
                                <input type="range" id="master-scrubber" min="0" max="100" value="0" step="0.1">
                            </div>
                    </div>
                    <div id="collapsible-controls" class="collapsible-panel">
                            <div class="panel-section">
                                <div class="camera-toggles" id="camera-toggles">
                                    <label class="toggle-label" for="select-all-cameras">All Cameras<label class="switch"><input type="checkbox" id="select-all-cameras" checked><span class="slider"></span></label></label>
                                    <div class="divider"></div>
                                    <label class="toggle-label" for="cam-front">Front<label class="switch"><input type="checkbox" id="cam-front" data-camera="front" checked><span class="slider"></span></label></label>
                                    <label class="toggle-label" for="cam-back">Back<label class="switch"><input type="checkbox" id="cam-back" data-camera="back" checked><span class="slider"></span></label></label>
                                    <label class="toggle-label" for="cam-left-repeater">L Fender<label class="switch"><input type="checkbox" id="cam-left-repeater" data-camera="left_repeater" checked><span class="slider"></span></label></label>
                                    <label class="toggle-label" for="cam-right-repeater">R Fender<label class="switch"><input type="checkbox" id="cam-right-repeater" data-camera="right_repeater" checked><span class="slider"></span></label></label>
                                    <label class="toggle-label" for="cam-left-pillar">L Pillar<label class="switch"><input type="checkbox" id="cam-left-pillar" data-camera="left_pillar" checked><span class="slider"></span></label></label>
                                    <label class="toggle-label" for="cam-right-pillar">R Pillar<label class="switch"><input type="checkbox" id="cam-right-pillar" data-camera="right_pillar" checked><span class="slider"></span></label></label>
                                </div>
                            </div>
                    </div>
             </div>
             <div class="video-grid-container">
                    <div class="video-grid" id="video-grid">
                        <div class="video-container front"><div class="video-label">Front</div><video class="front" muted playsinline></video></div>
                        <div class="video-container back"><div class="video-label">Back</div><video class="back" muted playsinline></video></div>
                        <div class="video-container left_repeater"><div class="video-label">Left Fender</div><video class="left_repeater" muted playsinline></video></div>
                        <div class="video-container right_repeater"><div class="video-label">Right Fender</div><video class="right_repeater" muted playsinline></video></div>
                        <div class="video-container left_pillar"><div class="video-label">Left Pillar</div><video class="left_pillar" muted playsinline></video></div>
                        <div class="video-container right_pillar"><div class="video-label">Right Pillar</div><video class="right_pillar" muted playsinline></video></div>
                    </div>
             </div>
        </div>

        <div id="TripRangeEstimator" class="tab-content">
            <div class="calculator-container">
                <h1>Trip Range Estimator</h1>
                <div class="grid">
                    <div class="form-group">
                        <label for="start-address">Start Address</label>
                        <div class="address-input-group">
                           <input type="text" id="start-address" placeholder="Enter starting point" autocomplete="off">
                           <button class="btn" id="use-current-location">Current Location</button>
                        </div>
                        <div id="start-address-results" class="autocomplete-results"></div>
                    </div>
                    <div class="form-group">
                        <label for="end-address">Destination Address</label>
                         <div class="address-input-group">
                            <input type="text" id="end-address" placeholder="Enter destination" autocomplete="off">
                        </div>
                        <div id="end-address-results" class="autocomplete-results"></div>
                    </div>
                </div>
                <div id="trip-planner-map"></div>
                <hr>
                <div class="grid">
                    <div class="form-group">
                        <label for="tesla-model">Vehicle</label>
                        <select id="tesla-model"></select>
                    </div>
                    <div class="form-group">
                        <label for="trip-start-soc">Starting Battery (%)</label>
                        <input type="number" id="trip-start-soc" value="90" min="0" max="100">
                    </div>
                </div>
                <div id="custom-vehicle-params" class="grid" style="display:none;">
                    <div class="form-group">
                        <label for="custom-capacity">Custom Capacity (kWh)</label>
                        <input type="number" id="custom-capacity" value="75">
                    </div>
                    <div class="form-group">
                        <label for="custom-efficiency">Custom Efficiency (Wh/mi)</label>
                        <input type="number" id="custom-efficiency" value="250">
                    </div>
                </div>
                <div class="options-container is-open">
                     <div class="options-content" style="max-height: 1000px; opacity: 1; margin-top: 0; padding-bottom: 1rem;">
                        <div class="grid-4">
                            <div class="form-group">
                                <label for="road-conditions">Road Conditions</label>
                                <select id="road-conditions">
                                    <option value="1.0" selected>Dry</option>
                                    <option value="1.15">Wet</option>
                                    <option value="1.3">Snow</option>
                                </select>
                            </div>
                             <div class="form-group">
                                <label for="wheel-size">Wheels</label>
                                <select id="wheel-size"></select>
                            </div>
                            <div class="form-group">
                                <label for="tire-pressure">Tire Pressure</label>
                                <select id="tire-pressure">
                                    <option value="1.0" selected>Optimal</option>
                                    <option value="1.03">Slightly Low</option>
                                    <option value="1.08">Low</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="payload">Additional Payload (lbs)</label>
                                <input type="number" id="payload" value="0" min="0" step="50">
                            </div>
                             <div class="form-group">
                                <label for="driving-style">Driving Style</label>
                                <select id="driving-style">
                                    <option value="0.95">Chill (FSD)</option>
                                    <option value="1.0" selected>Average (FSD)</option>
                                    <option value="1.1">Assertive (FSD)</option>
                                    <option value="manual">Manual</option>
                                </select>
                            </div>
                        </div>
                        <div id="manual-driving-slider-container" class="form-group slider-group" style="display:none;">
                            <label for="manual-aggression" class="slider-label"><span>Manual Driving: Eco</span><span>Aggressive</span></label>
                            <input type="range" id="manual-aggression" min="0.9" max="1.25" value="1.0" step="0.01">
                        </div>
                        <div class="grid">
                            <div class="form-group slider-group">
                                <label for="outdoor-temp" class="slider-label"><span>Outdoor Temperature</span><span id="outdoor-temp-value">70Â°F</span></label>
                                <input type="range" id="outdoor-temp" min="0" max="110" value="70">
                            </div>
                            <div class="form-group slider-group">
                                <label for="interior-temp" class="slider-label"><span>Interior Temperature</span><span id="interior-temp-value">70Â°F</span></label>
                                <input type="range" id="interior-temp" min="60" max="80" value="70">
                            </div>
                        </div>
                    </div>
                </div>
                <button class="primary-btn" id="calculate-trip-btn">Estimate Trip</button>
                <div id="trip-result" class="result-box">Enter trip details above to see your estimate.</div>
            </div>
        </div>
        
        <div id="ChargingEstimator" class="tab-content">
             <div class="calculator-container">
                    <h1>Charging Time Estimator</h1>
                    <div class="grid">
                        <div class="form-group"><label for="battery-capacity">Original Battery Capacity (kWh)</label><input type="number" id="battery-capacity" value="75"></div>
                        <div class="form-group"><label for="charger-efficiency">Charger Efficiency (%)</label><input type="number" id="charger-efficiency" value="85"></div>
                    </div>
                    <div class="grid">
                        <div class="form-group"><label for="current-soc">Current Battery (%)</label><input type="number" id="current-soc" placeholder="20" min="0" max="100"></div>
                        <div class="form-group"><label for="target-soc">Target Battery (%)</label><input type="number" id="target-soc" placeholder="80" min="0" max="100"></div>
                    </div>
                    <div class="form-group">
                        <label for="charger-type">Charger Type</label>
                        <select id="charger-type" onchange="toggleCustomParams()"><option value="1.5">Mobile (15A / 120V)</option><option value="7.7">Mobile (50A / 240V)</option><option value="9.6" selected>Level 2 (Workplace/Home)</option><option value="250">Supercharger</option><option value="custom">Custom...</option></select>
                    </div>
                    <div id="custom-params" style="display:none;"><hr><div class="grid"><div class="form-group"><label for="voltage">Voltage (V)</label><input type="number" id="voltage" placeholder="240"></div><div class="form-group"><label for="amps">Amps (A)</label><input type="number" id="amps" placeholder="32"></div></div></div>
                    <button class="primary-btn" onclick="calculateTime()">Calculate</button>
                    <div id="result" class="result-box"></div>
             </div>
        </div>

        <div id="PhantomDrain" class="tab-content">
             <div class="calculator-container">
                    <h1>Phantom Drain Estimator</h1>
                    
                    <!-- Mode Switcher -->
                    <div class="calc-mode-switcher">
                        <button id="mode-drain-time-btn" class="mode-btn active">Calculate Time to Drain</button>
                        <button id="mode-drain-percent-btn" class="mode-btn">Calculate % Lost Over Time</button>
                    </div>

                    <!-- ===== CALCULATOR 1: TIME TO DRAIN ===== -->
                    <div id="drainTimeCalculator" class="calc-mode-content active">
                        <div class="grid">
                            <div class="form-group"><label for="drain-current-soc">Current Battery (%)</label><input type="number" id="drain-current-soc" placeholder="80" min="0" max="100"></div>
                            <div class="form-group"><label for="drain-target-soc">Drain To (%)</label><input type="number" id="drain-target-soc" placeholder="20" min="0" max="100"></div>
                        </div>
                        
                        <div class="options-container">
                            <button type="button" class="options-toggle-btn">
                                <span>Refine Calculation (Optional)</span>
                                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                            <div class="options-content">
                                <div class="grid">
                                    <div class="form-group"><label for="drain-time-battery-health">Current Battery Health (%)</label><input type="number" id="drain-time-battery-health" value="100" min="50" max="100"></div>
                                    <div class="form-group"><label for="drain-time-outside-temp">Outside Temperature (Â°F)</label><input type="number" id="drain-time-outside-temp" value="70"></div>
                                </div>
                                <div class="form-group">
                                    <label>Auxiliary Features Enabled:</label>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-time-sentry" name="drain-time-feature" value="230"><label for="drain-time-sentry">Sentry Mode</label></div>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-time-summon" name="drain-time-feature" value="150"><label for="drain-time-summon">Summon Standby</label></div>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-time-accessory" name="drain-time-feature" value="100"><label for="drain-time-accessory">Keep Accessory Power On</label></div>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-time-climate" name="drain-time-feature" value="1000"><label for="drain-time-climate">Keep Climate On (A/C)</label></div>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-time-overheat-ac" name="drain-time-feature" value="150"><label for="drain-time-overheat-ac">Cabin Overheat Protection (A/C)</label></div>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-time-overheat-fan" name="drain-time-feature" value="50"><label for="drain-time-overheat-fan">Cabin Overheat Protection (Fan Only)</label></div>
                                </div>
                            </div>
                        </div>

                        <button class="primary-btn" onclick="calculateDrainTime()">Calculate Drain Time</button>
                        <div id="drain-time-result" class="result-box"></div>
                    </div>

                    <!-- ===== CALCULATOR 2: % LOST OVER TIME ===== -->
                    <div id="drainPercentCalculator" class="calc-mode-content">
                        <div class="form-group">
                            <label for="drain-current-soc-percent">Current Battery (%)</label>
                            <input type="number" id="drain-current-soc-percent" placeholder="80" min="0" max="100">
                        </div>
                        <div class="grid">
                            <div class="form-group">
                                <label for="drain-start-date">Start Date</label>
                                <input type="date" id="drain-start-date">
                            </div>
                            <div class="form-group">
                                <label for="drain-start-time">Start Time</label>
                                <input type="time" id="drain-start-time">
                            </div>
                        </div>
                        <div class="grid">
                            <div class="form-group">
                                <label for="drain-end-date">End Date</label>
                                <input type="date" id="drain-end-date">
                            </div>
                            <div class="form-group">
                                <label for="drain-end-time">End Time</label>
                                <input type="time" id="drain-end-time">
                            </div>
                        </div>

                        <div class="options-container">
                            <button type="button" class="options-toggle-btn">
                                <span>Refine Calculation (Optional)</span>
                                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                            <div class="options-content">
                                <div class="grid">
                                    <div class="form-group"><label for="drain-percent-battery-health">Current Battery Health (%)</label><input type="number" id="drain-percent-battery-health" value="100" min="50" max="100"></div>
                                    <div class="form-group"><label for="drain-percent-outside-temp">Outside Temperature (Â°F)</label><input type="number" id="drain-percent-outside-temp" value="70"></div>
                                </div>
                                <div class="form-group">
                                    <label>Auxiliary Features Enabled:</label>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-percent-sentry" name="drain-percent-feature" value="230"><label for="drain-percent-sentry">Sentry Mode</label></div>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-percent-summon" name="drain-percent-feature" value="150"><label for="drain-percent-summon">Summon Standby</label></div>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-percent-accessory" name="drain-percent-feature" value="100"><label for="drain-percent-accessory">Keep Accessory Power On</label></div>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-percent-climate" name="drain-percent-feature" value="1000"><label for="drain-percent-climate">Keep Climate On (A/C)</label></div>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-percent-overheat-ac" name="drain-percent-feature" value="150"><label for="drain-percent-overheat-ac">Cabin Overheat Protection (A/C)</label></div>
                                    <div class="checkbox-group"><input type="checkbox" id="drain-percent-overheat-fan" name="drain-percent-feature" value="50"><label for="drain-percent-overheat-fan">Cabin Overheat Protection (Fan Only)</label></div>
                                </div>
                            </div>
                        </div>

                        <button class="primary-btn" onclick="calculateDrainPercentage()">Calculate Percentage Lost</button>
                        <div id="drain-percent-result" class="result-box"></div>
                    </div>
             </div>
        </div>

        <div id="About" class="tab-content">
            <div class="info-container">
                <h1>About Tesla Companion</h1>
                <p>This application was created to provide an easy-to-use toolkit for Tesla owners. It combines several useful utilities into a single, responsive web interface that works on any device.</p>
                
                <h2>Credits & Acknowledgements</h2>
                <ul>
                    <li>The core Camera Viewer functionality was originally created by <strong>Lythinari</strong>. You can find the original project on <a href="https://github.com/Lythinari/TeslaCamViewer" target="_blank" style="color: var(--primary-color);">GitHub</a>.</li>
                    <li>This version was further edited and refined by <strong>Joshua Leshnick</strong>. You can find the project on <a href="https://github.com/JLeshnick/TeslaCompanion" target="_blank" style="color: var(--primary-color);">GitHub</a>.</li>
                    <li>This app was built with HTML5, CSS3, and modern JavaScript.</li>
                    <li>Icons provided by Feather Icons.</li>
                    <li>Font by Google Fonts (Inter).</li>
                </ul>

                <h2>Disclaimer</h2>
                <p>This is an unofficial, open-source community project and is not affiliated with Tesla, Inc. All calculations are estimates and should be used for informational purposes only.</p>
            </div>
        </div>
    </div>
</div>

<div id="map-container">
    <div id="map-close-button">Ã—</div>
    <iframe id="map-iframe" src="" frameborder="0" allowfullscreen></iframe>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = {
            playbackRate: 1, carouselIndex: 0, eventClips: new Map(),
            sortedEventKeys: [], currentEventData: {},
            // Trip Planner State
            tripMap: null,
            routingControl: null,
        };

        const dom = {
            landingPage: document.getElementById('landing-page'),
            launchAppBtn: document.getElementById('launch-app-btn'),
            appContainer: document.querySelector('.layout-container'),
            body: document.body,
            videoGrid: document.querySelector("#video-grid"),
            allVideos: document.querySelectorAll("video"), 
            frontVideo: document.querySelector("video.front"),
            fileBrowser: document.querySelector("#fileBrowser"),
            dateSelector: document.querySelector("#date-select"),
            nextButton: document.querySelector("button.next"),
            previousButton: document.querySelector("button.previous"),
            masterScrubber: document.querySelector("#master-scrubber"),
            liveTimestamp: document.querySelector("#live-timestamp"),
            durationDisplay: document.querySelector("#duration-display"),
            playPauseButton: document.querySelector("#play-pause-button"),
            playIcon: document.querySelector("#play-icon"), 
            pauseIcon: document.querySelector("#pause-icon"),
            statusDot: document.querySelector('.status-dot'),
            eventMarker: document.querySelector("#event-marker"),
            jumpToEventButton: document.querySelector("#jump-to-event"),
            mapButton: document.getElementById('map-button'),
            mapContainer: document.getElementById('map-container'),
            mapIframe: document.getElementById('map-iframe'),
            mapCloseButton: document.getElementById('map-close-button'),
            cameraToggles: document.querySelector("#camera-toggles"),
            selectAllCameras: document.querySelector('#select-all-cameras'),
            themeToggle: document.querySelector('#theme-toggle'),
            themeIconSun: document.querySelector('#theme-icon-sun'),
            themeIconMoon: document.querySelector('#theme-icon-moon'),
            fullscreenToggle: document.getElementById('fullscreen-toggle'),
            maximizeIcon: document.getElementById('maximize-icon'),
            minimizeIcon: document.getElementById('minimize-icon'),
            skipForwardButton: document.querySelector('#skip-forward'),
            skipRewindButton: document.querySelector('#skip-rewind'),
            playbackSpeedSelector: document.querySelector('#playback-speed'),
            collapsibleControls: document.querySelector('#collapsible-controls'),
            titleFolderName: document.querySelector('.title-folder-name'),
            eventDetailsContainer: document.getElementById('event-details-container'),
            eventReasonDisplay: document.getElementById('event-reason-display'),
            eventTimeDisplay: document.getElementById('event-time-display'),
            eventTriggerDisplay: document.getElementById('event-trigger-display'),
            eventCityDisplay: document.getElementById('event-city-display'),
            screenshotBtn: document.querySelector('#screenshot-btn'),
            cameraControlsContainer: document.getElementById('camera-controls-container'),
            // Phantom Drain Elements
            modeDrainTimeBtn: document.getElementById('mode-drain-time-btn'),
            modeDrainPercentBtn: document.getElementById('mode-drain-percent-btn'),
            drainTimeCalculator: document.getElementById('drainTimeCalculator'),
            drainPercentCalculator: document.getElementById('drainPercentCalculator'),
            // Trip Planner Elements
            tripPlannerMap: document.getElementById('trip-planner-map'),
            startAddressInput: document.getElementById('start-address'),
            startAddressResults: document.getElementById('start-address-results'),
            endAddressInput: document.getElementById('end-address'),
            endAddressResults: document.getElementById('end-address-results'),
            useCurrentLocationBtn: document.getElementById('use-current-location'),
            calculateTripBtn: document.getElementById('calculate-trip-btn'),
            tripResultDiv: document.getElementById('trip-result'),
            outdoorTempSlider: document.getElementById('outdoor-temp'),
            outdoorTempValue: document.getElementById('outdoor-temp-value'),
            interiorTempSlider: document.getElementById('interior-temp'),
            interiorTempValue: document.getElementById('interior-temp-value'),
            teslaModelSelect: document.getElementById('tesla-model'),
            customVehicleParams: document.getElementById('custom-vehicle-params'),
            wheelSelect: document.getElementById('wheel-size'),
            drivingStyleSelect: document.getElementById('driving-style'),
            manualAggressionContainer: document.getElementById('manual-driving-slider-container'),
            manualAggressionSlider: document.getElementById('manual-aggression'),
            payloadInput: document.getElementById('payload'),
            roadConditionsSelect: document.getElementById('road-conditions'),
            tirePressureSelect: document.getElementById('tire-pressure'),
        };

        const friendlyEventReasons = {
            'sentry_aware_object_detection': 'Sentry: Object Detected',
            'user_interaction_dashcam_icon_tapped': 'Dashcam Saved (Manual)',
            'user_interaction_honk': 'Dashcam Saved (Honk)',
            'sentry_locked_handle_pulled': 'Sentry: Handle Pulled',
            'user_interaction_dashcam_multifunction_selected': 'Dashcam Saved (Manual)',
        };
        
        const teslaModelData = {
            'm3-sr': { name: 'Model 3 Standard Range', epaRange: 272, capacity: 54, efficiency: 250, wheels: { '18" Aero': 1.0, '19" Sport': 1.04 } },
            'm3-lr': { name: 'Model 3 Long Range', epaRange: 333, capacity: 75, efficiency: 250, wheels: { '18" Aero': 1.0, '19" Sport': 1.04 } },
            'm3-p': { name: 'Model 3 Performance', epaRange: 315, capacity: 75, efficiency: 260, wheels: { '20" Uberturbine': 1.0 } },
            'my-lr': { name: 'Model Y Long Range', epaRange: 330, capacity: 75, efficiency: 280, wheels: { '19" Gemini': 1.0, '20" Induction': 1.05 } },
            'my-p': { name: 'Model Y Performance', epaRange: 303, capacity: 75, efficiency: 300, wheels: { '21" Uberturbine': 1.0 } },
            'ms-lr': { name: 'Model S Long Range', epaRange: 405, capacity: 100, efficiency: 280, wheels: { '19" Tempest': 1.0, '21" Arachnid': 1.06 } },
            'ms-plaid': { name: 'Model S Plaid', epaRange: 396, capacity: 100, efficiency: 290, wheels: { '19" Tempest': 1.0, '21" Arachnid': 1.06 } },
            'mx-lr': { name: 'Model X Long Range', epaRange: 348, capacity: 100, efficiency: 320, wheels: { '20" Cyberstream': 1.0, '22" Turbine': 1.08 } },
            'mx-plaid': { name: 'Model X Plaid', epaRange: 333, capacity: 100, efficiency: 330, wheels: { '20" Cyberstream': 1.0, '22" Turbine': 1.08 } },
            'ct-awd': { name: 'Cybertruck AWD', epaRange: 340, capacity: 123, efficiency: 450, wheels: { '35" All-Terrain': 1.0 } },
        };

        window.openTab = (evt, tabName) => {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) tabcontent[i].classList.remove("active");
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) tablinks[i].classList.remove("active");
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
            dom.cameraControlsContainer.style.display = (tabName === 'CameraViewer') ? 'block' : 'none';

            if (tabName === 'PhantomDrain') {
                setDefaultDrainTimes();
            }
            if (tabName === 'TripRangeEstimator' && !state.tripMap) {
                initTripPlannerMap();
            }
        }

        const applyTheme = (theme) => {
            if (theme === 'light') {
                dom.body.classList.add('light-mode');
                dom.tripPlannerMap.classList.remove('dark-mode');
                dom.themeIconSun.style.display = 'none';
                dom.themeIconMoon.style.display = 'block';
            } else {
                dom.body.classList.remove('light-mode');
                dom.tripPlannerMap.classList.add('dark-mode');
                dom.themeIconSun.style.display = 'block';
                dom.themeIconMoon.style.display = 'none';
            }
        }
        
        window.toggleCustomParams = () => {
            document.getElementById('custom-params').style.display = (document.getElementById('charger-type').value === 'custom') ? 'block' : 'none';
        }

        window.calculateTime = () => {
            const capacity = parseFloat(document.getElementById('battery-capacity').value);
            const efficiency = parseFloat(document.getElementById('charger-efficiency').value) / 100;
            const currentSOC = parseFloat(document.getElementById('current-soc').value);
            const targetSOC = parseFloat(document.getElementById('target-soc').value);
            const chargerType = document.getElementById('charger-type').value;
            const resultDiv = document.getElementById('result');

            if (isNaN(capacity) || isNaN(currentSOC) || isNaN(targetSOC) || currentSOC >= targetSOC) {
                resultDiv.innerHTML = "Please enter valid capacity and battery percentages.";
                return;
            }

            let chargerPower = 0;
            if (chargerType === 'custom') {
                const voltage = parseFloat(document.getElementById('voltage').value);
                const amps = parseFloat(document.getElementById('amps').value);
                if (isNaN(voltage) || isNaN(amps) || voltage <= 0 || amps <= 0) {
                    resultDiv.innerHTML = "Please enter valid Voltage and Amperage.";
                    return;
                }
                chargerPower = (voltage * amps) / 1000;
            } else {
                chargerPower = parseFloat(chargerType);
            }

            const energyNeeded = (targetSOC - currentSOC) / 100 * capacity;
            const timeHours = energyNeeded / (chargerPower * (chargerPower === 250 ? 1 : efficiency));
            const hours = Math.floor(timeHours);
            const minutes = Math.round((timeHours - hours) * 60);

            let resultText = `Estimated time to charge:<br><strong>`;
              if (hours > 0) resultText += `${hours} hr `;
            if (minutes > 0) resultText += `${minutes} min`;
            if (hours === 0 && minutes === 0) resultText = "Charge time is less than a minute.";
            resultDiv.innerHTML = resultText + `</strong>`;
        }

        // --- Phantom Drain Calculator Logic (Updated) ---

        function getDrainParameters() {
            const prefix = dom.drainTimeCalculator.classList.contains('active') ? 'drain-time-' : 'drain-percent-';
            
            const originalCapacity = 75; // Base capacity in kWh
            const batteryHealth = parseFloat(document.getElementById(prefix + 'battery-health').value) / 100;
            const outsideTempF = parseFloat(document.getElementById(prefix + 'outside-temp').value);

            let totalDrainWatts = 0;
            let featuresActive = false;
            document.getElementsByName(prefix + 'feature').forEach(feature => {
                if (feature.checked) {
                    featuresActive = true;
                    totalDrainWatts += parseFloat(feature.value);
                }
            });

            // If no specific features are active, assume a base idle drain for a sleeping car.
            if (!featuresActive) {
                totalDrainWatts = 50; 
            }
            
            // Adjust drain based on temperature, as the battery management system may activate.
            let tempMultiplier = 1.0;
            if (outsideTempF > 90) { // Extreme heat can trigger battery cooling.
                tempMultiplier = 1.5; 
            } else if (outsideTempF < 40) { // Extreme cold can trigger battery heating.
                tempMultiplier = 2.0; 
            }

            const actualDrainWatts = totalDrainWatts * tempMultiplier;
            const currentCapacityKwh = originalCapacity * batteryHealth;

            if (isNaN(batteryHealth) || isNaN(outsideTempF)) {
                return null;
            }

            return { actualDrainWatts, currentCapacityKwh };
        }

        window.calculateDrainTime = () => {
            const resultDiv = document.getElementById('drain-time-result');
            const currentSOC = parseFloat(document.getElementById('drain-current-soc').value);
            const targetSOC = parseFloat(document.getElementById('drain-target-soc').value);
            
            if (isNaN(currentSOC) || isNaN(targetSOC) || currentSOC <= targetSOC) {
                resultDiv.innerHTML = "Please enter valid battery percentages (Current > Target).";
                return;
            }

            const params = getDrainParameters();
            if (!params) {
                resultDiv.innerHTML = "Please enter valid battery health and temperature.";
                return;
            }
            
            const energyToDrainWh = (currentSOC - targetSOC) / 100 * params.currentCapacityKwh * 1000;
            const timeHours = energyToDrainWh / params.actualDrainWatts;
            
            const days = Math.floor(timeHours / 24);
            const hours = Math.floor(timeHours % 24);

            let resultText = `Estimated time to drain:<br><strong>`;
            if (days > 0) resultText += `${days} days `;
            if (hours > 0) resultText += `${hours} hours`;
            if (days === 0 && hours === 0) resultText = "Drain time is very short.";
            resultDiv.innerHTML = resultText + `</strong>`;
        }

        window.calculateDrainPercentage = () => {
            const resultDiv = document.getElementById('drain-percent-result');
            const currentSOC = parseFloat(document.getElementById('drain-current-soc-percent').value);
            
            const startDateStr = document.getElementById('drain-start-date').value;
            const startTimeStr = document.getElementById('drain-start-time').value;
            const endDateStr = document.getElementById('drain-end-date').value;
            const endTimeStr = document.getElementById('drain-end-time').value;

            if (isNaN(currentSOC)) {
                 resultDiv.innerHTML = "Please enter a valid current battery percentage.";
                 return;
            }

            if (!startDateStr || !startTimeStr || !endDateStr || !endTimeStr) {
                resultDiv.innerHTML = "Please enter valid start and end dates/times.";
                return;
            }

            const startTime = new Date(`${startDateStr}T${startTimeStr}`);
            const endTime = new Date(`${endDateStr}T${endTimeStr}`);

            if (endTime <= startTime) {
                resultDiv.innerHTML = "End time must be after the start time.";
                return;
            }

            const params = getDrainParameters();
            if (!params) {
                resultDiv.innerHTML = "Please enter valid battery health and temperature.";
                return;
            }

            const durationMillis = endTime - startTime;
            const durationHours = durationMillis / (1000 * 60 * 60);

            const energyDrainedWh = params.actualDrainWatts * durationHours;
            const energyDrainedKwh = energyDrainedWh / 1000;

            const percentageLost = (energyDrainedKwh / params.currentCapacityKwh) * 100;
            const finalSOC = currentSOC - percentageLost;

            resultDiv.innerHTML = `Estimated drain: <strong>${percentageLost.toFixed(1)}%</strong><br>Final SOC will be ~<strong>${finalSOC.toFixed(1)}%</strong>`;
        }

        function setDefaultDrainTimes() {
            const now = new Date();
            const year = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');

            document.getElementById('drain-start-date').value = `${year}-${mm}-${dd}`;
            document.getElementById('drain-start-time').value = `${hh}:${min}`;

            // Default end date to tomorrow
            const tomorrow = new Date(now);
            tomorrow.setDate(now.getDate() + 1);
            const year_t = tomorrow.getFullYear();
            const mm_t = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const dd_t = String(tomorrow.getDate()).padStart(2, '0');
            document.getElementById('drain-end-date').value = `${year_t}-${mm_t}-${dd_t}`;
            document.getElementById('drain-end-time').value = `${hh}:${min}`;
        }

        function switchDrainMode(mode) {
            if (mode === 'time') {
                dom.modeDrainTimeBtn.classList.add('active');
                dom.modeDrainPercentBtn.classList.remove('active');
                dom.drainTimeCalculator.classList.add('active');
                dom.drainPercentCalculator.classList.remove('active');
            } else { // mode === 'percent'
                dom.modeDrainTimeBtn.classList.remove('active');
                dom.modeDrainPercentBtn.classList.add('active');
                dom.drainTimeCalculator.classList.remove('active');
                dom.drainPercentCalculator.classList.add('active');
                setDefaultDrainTimes(); // Set defaults when switching to this mode
            }
        }

        // --- Trip Planner Logic (Leaflet) ---
        function populateVehicleSelect() {
            dom.teslaModelSelect.innerHTML = '';
            for (const [key, model] of Object.entries(teslaModelData)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${model.name} (${model.epaRange} mi)`;
                dom.teslaModelSelect.appendChild(option);
            }
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = 'Custom...';
            dom.teslaModelSelect.appendChild(customOption);
        }

        function updateWheelOptions() {
            const modelKey = dom.teslaModelSelect.value;
            dom.wheelSelect.innerHTML = '';
            if (modelKey !== 'custom' && teslaModelData[modelKey] && teslaModelData[modelKey].wheels) {
                for (const [name, efficiency] of Object.entries(teslaModelData[modelKey].wheels)) {
                    const option = document.createElement('option');
                    option.value = efficiency;
                    option.textContent = name;
                    dom.wheelSelect.appendChild(option);
                }
                dom.wheelSelect.parentElement.style.display = 'block';
            } else {
                 dom.wheelSelect.parentElement.style.display = 'none';
            }
        }

        function initTripPlannerMap() {
            state.tripMap = L.map(dom.tripPlannerMap).setView([34.7304, -86.5861], 8); // Huntsville, AL
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(state.tripMap);
            
            populateVehicleSelect();
            updateWheelOptions();
            applyTheme(localStorage.getItem('theme') || 'dark');
            
            initAutocomplete(dom.startAddressInput, dom.startAddressResults);
            initAutocomplete(dom.endAddressInput, dom.endAddressResults);
        }

        function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async position => {
                    const { latitude, longitude } = position.coords;
                    // Use Nominatim for reverse geocoding (coords to address)
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                    const data = await response.json();
                    if (data && data.display_name) {
                        dom.startAddressInput.value = data.display_name;
                    } else {
                        alert("Could not find address for your location.");
                    }
                }, () => {
                    alert("Error: The Geolocation service failed.");
                });
            } else {
                alert("Error: Your browser doesn't support geolocation.");
            }
        }
        
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };

        async function fetchAutocompleteResults(query, resultsContainer) {
            if (query.length < 2) { // Trigger autocomplete sooner
                resultsContainer.innerHTML = '';
                resultsContainer.style.display = 'none';
                return;
            }
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
            const results = await response.json();
            
            resultsContainer.innerHTML = '';
            if (results.length > 0) {
                results.forEach(result => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = result.display_name;
                    item.onclick = () => {
                        resultsContainer.previousElementSibling.querySelector('input').value = result.display_name;
                        resultsContainer.innerHTML = '';
                        resultsContainer.style.display = 'none';
                    };
                    resultsContainer.appendChild(item);
                });
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.style.display = 'none';
            }
        }

        function initAutocomplete(inputElement, resultsContainer) {
            const debouncedFetch = debounce(fetchAutocompleteResults, 250); // Reduced delay
            inputElement.addEventListener('input', () => {
                debouncedFetch(inputElement.value, resultsContainer);
            });
        }

        // Helper function to convert an address to coordinates
        async function geocodeAddress(address) {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
            const results = await response.json();
            if (results && results.length > 0) {
                return L.latLng(results[0].lat, results[0].lon);
            } else {
                throw new Error(`Could not find coordinates for "${address}"`);
            }
        }

        async function calculateAndDisplayRoute() {
            const startAddress = dom.startAddressInput.value;
            const endAddress = dom.endAddressInput.value;
            dom.tripResultDiv.innerHTML = 'Calculating route...';

            if (!startAddress || !endAddress) {
                dom.tripResultDiv.innerHTML = "Please enter both a start and destination address.";
                return;
            }

            if (state.routingControl) {
                state.tripMap.removeControl(state.routingControl);
                state.routingControl = null;
            }

            try {
                // First, convert addresses to coordinates
                const [startWaypoint, endWaypoint] = await Promise.all([
                    geocodeAddress(startAddress),
                    geocodeAddress(endAddress)
                ]);

                // Then, create the route with the found coordinates
                state.routingControl = L.Routing.control({
                    waypoints: [startWaypoint, endWaypoint],
                    routeWhileDragging: false,
                    createMarker: () => null, // Hide default markers
                    show: false, // Hide the default turn-by-turn panel
                    lineOptions: {
                        styles: [{ color: 'var(--primary-color)', opacity: 0.8, weight: 6 }]
                    },
                    // Add router to get elevation data
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: 'driving',
                        routingOptions: {
                            alternatives: true,
                            steps: true,
                            overview: 'full',
                            geometries: 'geojson'
                        }
                    })
                }).on('routesfound', function(e) {
                    var routes = e.routes;
                    estimateTrip(routes[0]);
                }).on('routingerror', function(e) {
                    dom.tripResultDiv.innerHTML = `Could not find a route. Error: ${e.error.message}`;
                }).addTo(state.tripMap);

            } catch (error) {
                console.error("Geocoding/Routing Error:", error);
                dom.tripResultDiv.innerHTML = error.message;
            }
        }


        function estimateTrip(route) {
            const distanceMeters = route.summary.totalDistance;
            const distanceMiles = distanceMeters * 0.000621371;
            
            // Elevation calculation
            let elevationGainMeters = 0;
            if (route.coordinates && route.coordinates.length > 0) {
                for (let i = 1; i < route.coordinates.length; i++) {
                    if(route.coordinates[i].alt > route.coordinates[i-1].alt) {
                       elevationGainMeters += route.coordinates[i].alt - route.coordinates[i-1].alt;
                    }
                }
            }
            const elevationGainFeet = elevationGainMeters * 3.28084;


            const modelKey = dom.teslaModelSelect.value;
            let model;

            if (modelKey === 'custom') {
                model = {
                    capacity: parseFloat(document.getElementById('custom-capacity').value),
                    efficiency: parseFloat(document.getElementById('custom-efficiency').value),
                };
            } else {
                model = teslaModelData[modelKey];
            }
            
            const startSOC = parseFloat(document.getElementById('trip-start-soc').value);
            const outdoorTempF = parseFloat(dom.outdoorTempSlider.value);
            const interiorTempF = parseFloat(dom.interiorTempSlider.value);
            const payloadLbs = parseFloat(dom.payloadInput.value);
            
            let drivingStyleMultiplier = parseFloat(dom.drivingStyleSelect.value);
            if (dom.drivingStyleSelect.value === 'manual') {
                drivingStyleMultiplier = parseFloat(dom.manualAggressionSlider.value);
            }
            const wheelMultiplier = parseFloat(dom.wheelSelect.value) || 1.0;
            const roadConditionMultiplier = parseFloat(dom.roadConditionsSelect.value);
            const tirePressureMultiplier = parseFloat(dom.tirePressureSelect.value);
            
            if (isNaN(startSOC) || isNaN(model.capacity) || isNaN(model.efficiency)) {
                dom.tripResultDiv.innerHTML = "Please enter valid vehicle and battery info.";
                return;
            }

            // 1. Base consumption adjusted for wheels and driving style
            let adjustedEfficiency = model.efficiency * wheelMultiplier * drivingStyleMultiplier * roadConditionMultiplier * tirePressureMultiplier;
            let totalWhConsumed = distanceMiles * adjustedEfficiency;

            // 2. Temperature effect on battery efficiency
            let tempMultiplier = 1.0;
            if (outdoorTempF < 40) { // Cold penalty
                tempMultiplier = 1 + (40 - outdoorTempF) * 0.015; // 1.5% less efficient per degree below 40F
            } else if (outdoorTempF > 90) { // Hot penalty
                tempMultiplier = 1 + (outdoorTempF - 90) * 0.005; // 0.5% less efficient per degree above 90F
            }
            totalWhConsumed *= tempMultiplier;

            // 3. HVAC consumption
            const tempDifference = Math.abs(outdoorTempF - interiorTempF);
            if (tempDifference > 5) {
                const hvacWatts = 250 + Math.pow(tempDifference, 2) * 2; // Simple curve
                const tripDurationHours = (distanceMiles / 55); // Assume avg speed of 55 mph
                const hvacWhConsumed = hvacWatts * tripDurationHours;
                totalWhConsumed += hvacWhConsumed;
            }
            
            // 4. Payload consumption
            const payloadWhConsumed = (payloadLbs / 200) * 0.01 * totalWhConsumed; // 1% penalty per 200 lbs
            totalWhConsumed += payloadWhConsumed;

            // 5. Elevation consumption
            // Energy to lift mass (Wh) = mgh / 3600. Assume avg vehicle mass of 4500 lbs
            const totalMassKg = (4500 + payloadLbs) * 0.453592;
            const elevationWhConsumed = (totalMassKg * 9.81 * elevationGainMeters) / 3600;
            // Assume 60% regen braking efficiency on the way down
            const elevationWhRegained = elevationWhConsumed * 0.60;
            totalWhConsumed += (elevationWhConsumed - elevationWhRegained);


            const percentUsed = (totalWhConsumed / (model.capacity * 1000)) * 100;
            const endSOC = startSOC - percentUsed;

            dom.tripResultDiv.innerHTML = `
                Trip: <strong>${distanceMiles.toFixed(1)} miles</strong> | Elev. Gain: <strong>${Math.round(elevationGainFeet)} ft</strong><br>
                Estimated Arrival SOC: <strong style="color: ${endSOC < 20 ? 'var(--error-color)' : 'var(--success-color)'}; font-size: 1.5rem;">${Math.round(endSOC)}%</strong><br>
                <small>(Used ~${percentUsed.toFixed(1)}% of the battery)</small>
            `;
        }

        // --- Camera Viewer Logic ---
        async function loadEvent(index) {
            state.carouselIndex = index;
            if (index < 0 || index >= state.sortedEventKeys.length) return;
            pauseVideos();
            dom.masterScrubber.value = 0;
            dom.liveTimestamp.textContent = "00:00";
            dom.durationDisplay.textContent = "00:00";
            dom.eventMarker.style.display = "none";
            dom.jumpToEventButton.style.display = "none";
            dom.mapButton.style.display = 'none';
            dom.eventDetailsContainer.style.display = 'none';
            dom.eventReasonDisplay.innerHTML = '';
            dom.eventTimeDisplay.innerHTML = '';
            dom.eventTriggerDisplay.innerHTML = '';
            dom.eventCityDisplay.innerHTML = '';
            document.querySelectorAll('.video-container').forEach(c => c.classList.remove('triggered'));

            const eventKey = state.sortedEventKeys[index];
            const eventData = state.eventClips.get(eventKey);
            state.currentEventData = {
                playlists: eventData.playlists, clipDurations: [],
                totalDuration: 0, eventTriggerOffset: -1, firstClipTime: null,
                playlistIndices: { front: 0, back: 0, left_repeater: 0, right_repeater: 0, left_pillar: 0, right_pillar: 0 }
            };
            dom.titleFolderName.textContent = eventKey;
            dom.dateSelector.selectedIndex = index;

            let earliestFile = null;
            for (const camera in eventData.playlists) {
                if (eventData.playlists[camera].length > 0) {
                    if (!earliestFile || eventData.playlists[camera][0].name < earliestFile.name) {
                        earliestFile = eventData.playlists[camera][0];
                    }
                }
            }

            if (!earliestFile) return;

            const firstClipNameMatch = earliestFile.name.match(/^(\d{4}-\d{2}-\d{2}_\d{2}-\d{2}-\d{2})/);
            if (firstClipNameMatch) {
                const dateTimeString = firstClipNameMatch[1];
                const formattedDateTimeString = dateTimeString.substring(0, 10) + 'T' + dateTimeString.substring(11).replace(/-/g, ':');
                state.currentEventData.firstClipTime = new Date(formattedDateTimeString);
            } else {
                state.currentEventData.firstClipTime = null;
            }

            const masterPlaylist = state.currentEventData.playlists.front;
            if(masterPlaylist.length > 0) {
                state.currentEventData.clipDurations = await Promise.all(masterPlaylist.map(getVideoDuration));
                state.currentEventData.totalDuration = state.currentEventData.clipDurations.reduce((a, b) => a + b, 0);
            } else {
                state.currentEventData.clipDurations = [];
                state.currentEventData.totalDuration = 0;
            }

            if (state.currentEventData.firstClipTime) {
                updateLiveTimestamp(0);
                const endClipTime = new Date(state.currentEventData.firstClipTime.getTime() + (state.currentEventData.totalDuration * 1000));
                dom.durationDisplay.textContent = formatLocalTime(endClipTime);
            } else {
                dom.liveTimestamp.textContent = formatTime(0);
                dom.durationDisplay.textContent = formatTime(state.currentEventData.totalDuration);
            }
            
            if(eventData.eventJson) {
                try {
                    const jsonContent = await eventData.eventJson.text();
                    const jsonData = JSON.parse(jsonContent);
                    const eventTimeFromJSON = new Date(jsonData.timestamp);
                    const rawReason = jsonData.reason;
                    const isManualSave = rawReason.startsWith('user_interaction');
                    
                    dom.eventDetailsContainer.style.display = 'block';
                    const friendlyReason = friendlyEventReasons[rawReason] || rawReason.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    dom.eventReasonDisplay.innerHTML = `Event: <strong>${friendlyReason}</strong>`;
                    dom.eventTimeDisplay.innerHTML = `Event Time: <strong>${formatLocalTime(eventTimeFromJSON)}</strong>`;
                    if (jsonData.city) {
                        dom.eventCityDisplay.innerHTML = `Event City: <strong>${jsonData.city}</strong>`;
                    }
                     if (jsonData.est_lat && jsonData.est_lon) {
                        state.currentEventData.location = { lat: jsonData.est_lat, lon: jsonData.est_lon };
                        dom.mapButton.style.display = 'inline-flex';
                    }
                    const cameraIndexMap = { 0: 'front', 3: 'left_pillar', 4: 'right_pillar', 5: 'left_repeater', 6: 'right_repeater', 7: 'back' };
                    const triggerCameraName = cameraIndexMap[parseInt(jsonData.camera, 10)];
                    if (triggerCameraName) {
                        const displayName = triggerCameraName.replace('_repeater', ' Fender').replace('_pillar', ' Pillar').replace(/_/g, ' ');
                        dom.eventTriggerDisplay.innerHTML = `Trigger: <strong>${displayName.charAt(0).toUpperCase() + displayName.slice(1)}</strong>`;
                        const triggerContainer = document.querySelector(`.video-container.${triggerCameraName}`);
                        if(triggerContainer) triggerContainer.classList.add('triggered');
                    }

                    if (state.currentEventData.firstClipTime && state.currentEventData.totalDuration > 0) {
                        let offset = (eventTimeFromJSON.getTime() - state.currentEventData.firstClipTime.getTime()) / 1000;

                        if (isManualSave) {
                            const diffFromEnd = Math.abs(offset - state.currentEventData.totalDuration);
                            if (diffFromEnd > 1800) { 
                                const hourDifference = Math.round(offset / 3600);
                                if (hourDifference !== 0) {
                                    offset = state.currentEventData.totalDuration - 5; 
                                }
                            }
                        } else {
                             if (Math.abs(offset) > (state.currentEventData.totalDuration + 60)) {
                                const hourDifference = Math.round(offset / 3600);
                                if (hourDifference !== 0) {
                                    offset -= hourDifference * 3600;
                                }
                            }
                        }

                        if (offset >= -10 && offset <= state.currentEventData.totalDuration + 10) { 
                            state.currentEventData.eventTriggerOffset = Math.max(0, Math.min(offset, state.currentEventData.totalDuration));
                            updateEventMarkerPosition();
                            dom.eventMarker.style.display = "block";
                            dom.jumpToEventButton.style.display = "inline-flex";
                        }
                    }
                } catch (error) { console.error("Error processing event.json:", error); }
            }

            const loadPromises = [];
            dom.allVideos.forEach(video => {
                const cameraType = video.className.split(' ')[0];
                const playlist = state.currentEventData.playlists[cameraType];
                const fileToLoad = playlist && playlist.length > 0 ? playlist[0] : null;
                loadPromises.push(loadVideo(video, fileToLoad));
            });
            await Promise.all(loadPromises);
        }

        function loadVideo(videoElement, file) {
            return new Promise((resolve) => {
                if (videoElement.src.startsWith('blob:')) {
                    URL.revokeObjectURL(videoElement.src);
                }
                
                videoElement.playbackRate = state.playbackRate;
                
                if (!file) {
                    videoElement.src = '';
                    resolve();
                    return;
                }

                videoElement.addEventListener('canplay', function onCanPlay() {
                    resolve();
                }, { once: true });
                
                videoElement.addEventListener('error', function onError() {
                    console.error(`Error loading video file: ${file.name}`);
                    resolve();
                }, { once: true });

                videoElement.src = URL.createObjectURL(file);
            });
        }

        function updatePlayButtonUI(isPlaying) {
            dom.playIcon.style.display = isPlaying ? 'none' : 'block';
            dom.pauseIcon.style.display = isPlaying ? 'block' : 'none';
            dom.statusDot.classList.toggle('ready', !isPlaying);
            dom.statusDot.classList.toggle('playing', isPlaying);
        }
        function playVideos() {
            updatePlayButtonUI(true);
            dom.allVideos.forEach(v => { 
                if (v.src && v.paused) {
                    v.play().catch(error => console.error(`Play failed for ${v.className}:`, error));
                }
            });
        }
        function pauseVideos() { updatePlayButtonUI(false); dom.allVideos.forEach(v => v.pause()); }
        function playPause() { dom.frontVideo.paused && dom.frontVideo.src ? playVideos() : pauseVideos(); }
        function skipTo(seconds) { seekAllVideos(getCurrentTime() + seconds); }
        function setPlaybackSpeed(rate) {
            state.playbackRate = parseFloat(rate);
            dom.allVideos.forEach(video => { video.playbackRate = state.playbackRate; });
        }
        function seekAllVideos(targetTime) {
            if (isNaN(targetTime)) targetTime = 0;
            targetTime = Math.max(0, Math.min(targetTime, state.currentEventData.totalDuration));
            let timeIntoPlaylist = 0;
            let targetClipIndex = -1;
            for (let i = 0; i < state.currentEventData.clipDurations.length; i++) {
                if (targetTime <= timeIntoPlaylist + state.currentEventData.clipDurations[i] + 0.1) {
                    targetClipIndex = i; break;
                }
                timeIntoPlaylist += state.currentEventData.clipDurations[i];
            }
            if (targetClipIndex === -1) targetClipIndex = state.currentEventData.clipDurations.length - 1;
            const timeInTargetClip = targetTime - timeIntoPlaylist;
            const wasPlaying = !dom.frontVideo.paused;
            dom.allVideos.forEach(video => {
                const camera = video.className.split(' ')[0];
                state.currentEventData.playlistIndices[camera] = targetClipIndex;
                const playlist = state.currentEventData.playlists[camera];
                if (playlist && playlist[targetClipIndex]) {
                    if (!video.src.endsWith(playlist[targetClipIndex].name)) loadVideo(video, playlist[targetClipIndex]);
                    video.currentTime = timeInTargetClip;
                }
            });
            if (wasPlaying) playVideos();
        }
        function getCurrentTime() {
            if(!state.currentEventData?.clipDurations?.length) return 0;
            let elapsed = 0;
            for (let i = 0; i < state.currentEventData.playlistIndices.front; i++) {
                elapsed += (state.currentEventData.clipDurations[i] || 0);
            }
            return elapsed + dom.frontVideo.currentTime;
        }
        function updateLiveTimestamp(currentTimeOverride) {
            const currentTime = currentTimeOverride !== undefined ? currentTimeOverride : getCurrentTime();
            if (!state.currentEventData.firstClipTime) {
                dom.liveTimestamp.textContent = formatTime(currentTime);
                return;
            }
            const liveTime = new Date(state.currentEventData.firstClipTime.getTime() + (currentTime * 1000));
            dom.liveTimestamp.textContent = formatLocalTime(liveTime);
        }
        function updateEventMarkerPosition() { if (state.currentEventData.eventTriggerOffset > 0 && state.currentEventData.totalDuration > 0) dom.eventMarker.style.left = `${(state.currentEventData.eventTriggerOffset / state.currentEventData.totalDuration) * 100}%`; }
        function formatTime(seconds) { if (isNaN(seconds) || seconds < 0) return "0:00"; const mins = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60); return `${mins}:${secs.toString().padStart(2, '0')}`; }
        
        function formatLocalTime(date) { 
            if (!date || isNaN(date.getTime())) return '--:--:--'; 
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }); 
        }

        function getVideoDuration(file) { return new Promise(resolve => { const v = document.createElement('video'); v.preload = 'metadata'; v.onloadedmetadata = () => { URL.revokeObjectURL(v.src); resolve(v.duration); }; v.onerror = () => resolve(0); v.src = URL.createObjectURL(file); }); }
        
        function toggleFullscreen() {
            dom.body.classList.toggle('fullscreen-active');
            const isFullscreen = dom.body.classList.contains('fullscreen-active');
            dom.maximizeIcon.style.display = isFullscreen ? 'none' : 'block';
            dom.minimizeIcon.style.display = isFullscreen ? 'block' : 'none';
        }

        function closeMap() {
            dom.mapContainer.style.display = 'none';
            dom.mapIframe.src = '';
        }

        // --- Attach Event Listeners ---
        dom.launchAppBtn.addEventListener('click', () => {
            dom.landingPage.classList.add('hidden');
            dom.appContainer.classList.remove('hidden');
        });
        dom.themeToggle.addEventListener('click', () => {
            const newTheme = dom.body.classList.contains('light-mode') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        dom.playPauseButton.addEventListener('click', playPause);
        dom.dateSelector.addEventListener("change", (e) => loadEvent(parseInt(e.target.value)));
        dom.nextButton.addEventListener("click", () => { if (state.carouselIndex < state.sortedEventKeys.length - 1) loadEvent(++state.carouselIndex); });
        dom.previousButton.addEventListener("click", () => { if (state.carouselIndex > 0) loadEvent(--state.carouselIndex); });
        dom.jumpToEventButton.addEventListener("click", () => seekAllVideos(state.currentEventData.eventTriggerOffset));
        dom.skipForwardButton.addEventListener('click', () => skipTo(5));
        dom.skipRewindButton.addEventListener('click', () => skipTo(-5));
        dom.playbackSpeedSelector.addEventListener('change', (e) => setPlaybackSpeed(e.target.value));
        dom.selectAllCameras.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            dom.cameraToggles.querySelectorAll('input[data-camera]').forEach(checkbox => {
                checkbox.checked = isChecked; 
                document.querySelector(`.video-container.${checkbox.dataset.camera}`)?.classList.toggle('hidden', !isChecked);
            });
            dom.videoGrid.classList.toggle('single-view-mode', Array.from(dom.cameraToggles.querySelectorAll('input[data-camera]')).filter(cb => cb.checked).length === 1);
        });
        dom.cameraToggles.addEventListener("change", (e) => {
            if (e.target.dataset.camera) { 
                document.querySelector(`.video-container.${e.target.dataset.camera}`)?.classList.toggle('hidden', !e.target.checked);
                const individualCheckboxes = Array.from(dom.cameraToggles.querySelectorAll('input[data-camera]'));
                const checkedCount = individualCheckboxes.filter(cb => cb.checked).length;
                dom.videoGrid.classList.toggle('single-view-mode', checkedCount === 1);
                dom.selectAllCameras.checked = (checkedCount === individualCheckboxes.length);
            }
        });
        dom.masterScrubber.addEventListener("input", () => { if (state.currentEventData.totalDuration) updateLiveTimestamp((dom.masterScrubber.value / 100) * state.currentEventData.totalDuration); });
        dom.masterScrubber.addEventListener("change", () => { if (state.currentEventData.totalDuration) seekAllVideos((dom.masterScrubber.value / 100) * state.currentEventData.totalDuration); });
        dom.frontVideo.addEventListener("timeupdate", () => {
            if (!state.currentEventData.totalDuration || dom.masterScrubber.matches(':active')) return;
            dom.masterScrubber.value = (getCurrentTime() / state.currentEventData.totalDuration) * 100;
            updateLiveTimestamp();
        });

        dom.allVideos.forEach(video => {
            video.addEventListener("ended", async (e) => {
                const wasPlaying = dom.playIcon.style.display === 'none';
                const camera = e.target.className.split(' ')[0];

                if (!state.currentEventData.playlists || !state.currentEventData.playlists[camera]) {
                    return;
                }

                const currentIdx = ++state.currentEventData.playlistIndices[camera];
                const playlist = state.currentEventData.playlists[camera];

                if (playlist && currentIdx < playlist.length) {
                    await loadVideo(e.target, playlist[currentIdx]);
                    if (wasPlaying) {
                        e.target.play().catch(err => {
                            if (err.name !== 'AbortError') console.error('Error playing next clip:', err);
                        });
                    }
                } else if (camera === 'front') {
                    if (state.carouselIndex < state.sortedEventKeys.length - 1) {
                        await loadEvent(++state.carouselIndex);
                        if (wasPlaying) {
                            playVideos();
                        }
                    } else {
                        pauseVideos();
                    }
                }
            });
        });

        document.querySelectorAll('.video-container').forEach(container => {
            container.addEventListener('dblclick', (e) => {
                const grid = dom.videoGrid;
                const clickedContainer = e.currentTarget;
                if (grid.classList.contains('expanded-view')) {
                    if (clickedContainer.classList.contains('expanded')) {
                        grid.classList.remove('expanded-view');
                        clickedContainer.classList.remove('expanded');
                    }
                } else {
                    grid.classList.add('expanded-view');
                    clickedContainer.classList.add('expanded');
                }
            });
        });
        dom.fileBrowser.addEventListener("change", function(e) {
            state.eventClips.clear(); 
            state.sortedEventKeys = []; 
            dom.dateSelector.innerHTML = '<option>Select Event</option>';
            dom.titleFolderName.textContent = 'No Clips Selected';
            for (const file of e.target.files) {
                const pathParts = file.webkitRelativePath.split('/');
                if (pathParts.length < 2) continue;
                const eventId = pathParts[pathParts.length - 2];
                if (!state.eventClips.has(eventId)) state.eventClips.set(eventId, { playlists: { front: [], back: [], left_repeater: [], right_repeater: [], left_pillar: [], right_pillar: [] }, eventJson: null, fullPath: file.webkitRelativePath });
                const group = state.eventClips.get(eventId);
                const videoMatch = file.name.match(/(\d{4}-\d{2}-\d{2}_\d{2}-\d{2}-\d{2})-(.+?)\.mp4$/);
                if (videoMatch && group.playlists[videoMatch[2]]) group.playlists[videoMatch[2]].push(file);
                if (file.name === "event.json") group.eventJson = file;
            }
            for (const [_, data] of state.eventClips.entries()) { for (const camera in data.playlists) data.playlists[camera].sort((a, b) => a.name.localeCompare(b.name)); }
            state.sortedEventKeys = Array.from(state.eventClips.keys()).sort();
            if (state.sortedEventKeys.length === 0) { dom.titleFolderName.textContent = 'No Clips Found'; dom.dateSelector.innerHTML = '<option>No Events Found</option>'; return; }
            dom.dateSelector.innerHTML = '';
            state.sortedEventKeys.forEach((key, index) => { const option = document.createElement("option"); option.innerText = key; option.value = index; dom.dateSelector.appendChild(option); });
            loadEvent(0);
        });
        dom.screenshotBtn.addEventListener('click', () => {
            const visibleContainers = [...dom.videoGrid.querySelectorAll('.video-container:not(.hidden)')];
            if (visibleContainers.length === 0) return;
            const firstVideo = visibleContainers[0].querySelector('video');
            if (!firstVideo.src || firstVideo.videoWidth === 0) return;
            const videoWidth = firstVideo.videoWidth;
            const videoHeight = firstVideo.videoHeight;
            const gridMapping = { left_pillar: { col: 0, row: 0 }, front: { col: 1, row: 0 }, right_pillar: { col: 2, row: 0 }, left_repeater: { col: 0, row: 1 }, back: { col: 1, row: 1 }, right_repeater: { col: 2, row: 1 }, };
            const canvas = document.createElement('canvas');
            canvas.width = videoWidth * 3;
            canvas.height = videoHeight * 2;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg-color');
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            visibleContainers.forEach(container => {
                const video = container.querySelector('video');
                const cameraType = [...container.classList].find(c => gridMapping[c]);
                if (cameraType && video.videoWidth > 0) {
                    const { col, row } = gridMapping[cameraType];
                    const dx = col * videoWidth;
                    const dy = row * videoHeight;
                    ctx.drawImage(video, dx, dy, videoWidth, videoHeight);
                }
            });
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `Tesla-Companion-Screenshot-${timestamp}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        });
        dom.fullscreenToggle.addEventListener('click', toggleFullscreen);
        dom.mapButton.addEventListener('click', (e) => {
            e.preventDefault();
            if (state.currentEventData.location) {
                const { lat, lon } = state.currentEventData.location;
                const mapUrl = `https://www.google.com/maps?q=${lat},${lon}&hl=es;z=14&output=embed`;
                dom.mapIframe.src = mapUrl;
                dom.mapContainer.style.display = 'flex';
            }
        });
        dom.mapCloseButton.addEventListener('click', closeMap);
        dom.mapContainer.addEventListener('click', (e) => { if (e.target === dom.mapContainer) closeMap(); });
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            switch(e.key) {
                case ' ': e.preventDefault(); playPause(); break;
                case 'ArrowLeft': e.preventDefault(); skipTo(-5); break;
                case 'ArrowRight': e.preventDefault(); skipTo(5); break;
                case 'ArrowUp': e.preventDefault(); if (state.carouselIndex > 0) loadEvent(--state.carouselIndex); break;
                case 'ArrowDown': e.preventDefault(); if (state.carouselIndex < state.sortedEventKeys.length - 1) loadEvent(++state.carouselIndex); break;
                case 'Escape': if (dom.body.classList.contains('fullscreen-active')) { toggleFullscreen(); } closeMap(); break;
            }
        });

        // Phantom Drain Listeners
        dom.modeDrainTimeBtn.addEventListener('click', () => switchDrainMode('time'));
        dom.modeDrainPercentBtn.addEventListener('click', () => switchDrainMode('percent'));
        document.querySelectorAll('.options-toggle-btn').forEach(button => {
            button.addEventListener('click', () => {
                button.closest('.options-container').classList.toggle('is-open');
            });
        });

        // Trip Planner Listeners
        dom.useCurrentLocationBtn.addEventListener('click', useCurrentLocation);
        dom.calculateTripBtn.addEventListener('click', calculateAndDisplayRoute);
        dom.outdoorTempSlider.addEventListener('input', (e) => dom.outdoorTempValue.textContent = `${e.target.value}Â°F`);
        dom.interiorTempSlider.addEventListener('input', (e) => dom.interiorTempValue.textContent = `${e.target.value}Â°F`);
        dom.teslaModelSelect.addEventListener('change', () => {
            dom.customVehicleParams.style.display = dom.teslaModelSelect.value === 'custom' ? 'grid' : 'none';
            updateWheelOptions();
        });
        dom.drivingStyleSelect.addEventListener('change', () => {
             dom.manualAggressionContainer.style.display = dom.drivingStyleSelect.value === 'manual' ? 'block' : 'none';
        });
        
        // Hide autocomplete on global click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.address-input-group')) {
                dom.startAddressResults.style.display = 'none';
                dom.endAddressResults.style.display = 'none';
            }
        });


        // --- Initial App State ---
        applyTheme(localStorage.getItem('theme') || 'dark');
        dom.cameraControlsContainer.style.display = 'none'; 
    });

</script>

</body>
</html>
